name: Test PR Creation

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  test-pr-creation:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java Environment
        uses: ./.github/actions/setup-java-only
        with:
          cache-key-suffix: '-test-pr'
      
      - name: Install DMTools CLI
        run: |
          curl -fsSL https://github.com/IstiN/dmtools/releases/latest/download/install.sh | bash
          echo "$HOME/.dmtools/bin" >> $GITHUB_PATH
      
      - name: Verify DMTools Installation
        run: |
          dmtools --version || echo "dmtools installation check failed"
      
      - name: Create test file change
        run: |
          echo "# Test PR Creation" > TESTPR.md
          echo "" >> TESTPR.md
          echo "This is a test file created at $(date)" >> TESTPR.md
          echo "" >> TESTPR.md
          echo "Testing PR creation with complex markdown content." >> TESTPR.md
      
      - name: Create outputs/response.md
        run: |
          mkdir -p outputs
          cat > outputs/response.md << 'EOF'
          ## Development Summary

          ### Approach
          This is a **test PR** to verify that PR creation works with complex markdown content including:
          - Code blocks
          - Special characters
          - Multiple formatting options

          ### Implementation

          #### Code Changes
          ```java
          public class TestClass {
              private static final String TEST = "Hello World!";
              
              public void testMethod() {
                  System.out.println("Test: " + TEST);
                  // Dollar signs: $PATH, ${HOME}
                  String path = System.getenv("PATH");
              }
          }
          ```

          #### Shell Commands
          ```bash
          # Special characters test
          echo "Testing: $HOME, ${USER}, `date`"
          gh pr create --title "Test" --body "Body with \"quotes\""
          ```

          ### Test Coverage
          - ✅ **Shell escaping** - Dollar signs, quotes, backticks
          - ✅ **Code blocks** - Java, bash, markdown
          - ✅ **Special characters** - \n, \t, $, ", ', `
          - ✅ **Formatting** - Bold, italic, lists

          ### Results
          All tests should pass with proper escaping via `--body-file` approach! 🎉
          EOF
      
      - name: Run dmtools JSRunner to create PR
        env:
          PATH: "/home/runner/.dmtools/bin:/bin:/usr/bin:$PATH"
          # Jira Configuration
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE_PATH: ${{ vars.JIRA_BASE_PATH }}
          JIRA_AUTH_TYPE: ${{ vars.JIRA_AUTH_TYPE }}
          
          # GitHub Authentication for PR creation
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          
          # DMTools Integration Settings
          DMTOOLS_INTEGRATIONS: "jira,cli,file"
        run: |
          echo "Running dmtools JSRunner test..."
          dmtools run test-pr-creation.json || echo "Note: Jira integration may fail if ticket doesn't exist"
      
      - name: Show results
        if: always()
        run: |
          echo "=== Git Status ==="
          git status
          echo ""
          echo "=== Recent Branches ==="
          git branch -a | grep "test-pr" || echo "No test branches found"
          echo ""
          echo "=== Check GitHub for PR ==="
          gh pr list --limit 5 || echo "Could not list PRs"
