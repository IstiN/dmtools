name: Release DMtools AI Skill

on:
  push:
    tags:
      - 'skill-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.version.outputs.VERSION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/skill-v}
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Update version in metadata
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"

          # Update version in SKILL.md metadata
          if [ -f "dmtools-ai-docs/SKILL.md" ]; then
            sed -i "s/version: .*/version: $VERSION/" dmtools-ai-docs/SKILL.md
          fi

      - name: Create skill package
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          DIST_DIR="dist"
          mkdir -p $DIST_DIR

          # Create the single skill package
          echo "ðŸ“¦ Creating DMtools Agent Skill package..."
          cd dmtools-ai-docs

          # Create ZIP archive
          zip -r ../$DIST_DIR/dmtools-skill-v${VERSION}.zip . \
            -x "*.git*" \
            -x ".DS_Store" \
            -x "node_modules/*" \
            -x "*.swp" \
            -x ".cursorrules" \
            -x ".github/*"

          # Create tarball for *nix systems
          tar -czf ../$DIST_DIR/dmtools-skill-v${VERSION}.tar.gz \
            --exclude='.git*' \
            --exclude='.DS_Store' \
            --exclude='node_modules' \
            --exclude='.cursorrules' \
            --exclude='.github' \
            .

          cd ..

          # Copy install script
          cp dmtools-ai-docs/install.sh $DIST_DIR/
          chmod +x $DIST_DIR/install.sh

          echo "âœ… Skill package created:"
          ls -lh $DIST_DIR/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.zip *.tar.gz > checksums.sha256
          cat checksums.sha256

      - name: Create release notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          cat > dist/release-notes.md << 'EOF'
          # DMtools Agent Skill v$VERSION

          Universal AI assistant skill for DMtools - works with Cursor, Claude, Codex, and any Agent Skills compatible system.

          ## ðŸ“¦ Installation

          ### Automatic Installation (Recommended)
          ```bash
          curl -fsSL https://github.com/IstiN/dmtools-ai-docs/releases/download/skill-v$VERSION/install.sh | bash
          ```

          ### Manual Installation

          1. Download: `dmtools-skill-v$VERSION.zip`
          2. Extract to one of these directories:
             - `.cursor/skills/` (project-level Cursor)
             - `.claude/skills/` (project-level Claude)
             - `~/.cursor/skills/` (global Cursor)
             - `~/.claude/skills/` (global Claude)
             - `~/.codex/skills/` (global Codex)

          ## ðŸŽ¯ What's Included

          - âœ… Complete DMtools documentation
          - âœ… 67+ MCP tools reference
          - âœ… JavaScript agent development guide
          - âœ… Configuration guides for all integrations
          - âœ… Test generation with Xray
          - âœ… AI provider setup (Gemini, OpenAI, Claude)

          ## ðŸ“š Usage

          Once installed:
          - **Cursor**: Type `/dmtools` or mention DMtools in chat
          - **Claude**: Type `/dmtools` or ask about DMtools
          - **Other AI**: The skill loads automatically when relevant

          ### Example Questions
          - "How do I install DMtools?"
          - "Help me configure Jira integration"
          - "Create a JavaScript agent for test generation"
          - "Show me how to use MCP tools"

          ## ðŸ”„ Updating

          Re-run the installer to update:
          ```bash
          curl -fsSL https://github.com/IstiN/dmtools-ai-docs/releases/latest/download/install.sh | bash
          ```

          ## ðŸ“ Changelog

          See [CHANGELOG.md](https://github.com/IstiN/dmtools-ai-docs/blob/main/CHANGELOG.md) for changes.

          ## ðŸ› Support

          Report issues at: https://github.com/IstiN/dmtools/issues

          ---

          **Agent Skills Standard**: This skill follows the [Agent Skills](https://agentskills.io) standard for cross-platform compatibility.
          EOF

          # Replace version placeholders
          sed -i "s/\$VERSION/$VERSION/g" dist/release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('skill-v{0}', github.event.inputs.version) || github.ref_name }}
          name: DMtools Agent Skill v${{ steps.version.outputs.VERSION }}
          body_path: dist/release-notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          files: |
            dist/dmtools-skill-*.zip
            dist/dmtools-skill-*.tar.gz
            dist/install.sh
            dist/checksums.sha256

      - name: Update latest release pointer
        if: github.event.inputs.prerelease != 'true'
        run: |
          # Create/update a 'latest' tag for easy access
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -fa skill-latest -m "Latest skill release"
          git push origin skill-latest --force

  publish-npm:
    runs-on: ubuntu-latest
    needs: build-and-release
    if: github.event.inputs.prerelease != 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          registry-url: 'https://registry.npmjs.org'

      - name: Prepare NPM package
        run: |
          VERSION="${{ needs.build-and-release.outputs.version }}"

          # Create package.json for NPM
          cat > dmtools-ai-docs/package.json << EOF
          {
            "name": "@dmtools/agent-skill",
            "version": "$VERSION",
            "description": "Agent Skill for DMtools - AI-powered development toolkit (Cursor, Claude, Codex compatible)",
            "keywords": ["dmtools", "agent-skills", "cursor", "claude", "ai", "jira", "azure-devops"],
            "author": "DMtools Team",
            "license": "Apache-2.0",
            "repository": {
              "type": "git",
              "url": "https://github.com/IstiN/dmtools.git"
            },
            "bugs": {
              "url": "https://github.com/IstiN/dmtools/issues"
            },
            "homepage": "https://github.com/IstiN/dmtools#readme",
            "files": [
              "SKILL.md",
              "references/**/*",
              "install.sh"
            ],
            "scripts": {
              "postinstall": "echo 'DMtools Agent Skill installed. Add to your AI assistant skills directory.'"
            }
          }
          EOF

      - name: Publish to NPM
        run: |
          cd dmtools-ai-docs
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true

  notify:
    runs-on: ubuntu-latest
    needs: [build-and-release]
    if: always()

    steps:
      - name: Send notification
        run: |
          VERSION="${{ needs.build-and-release.outputs.version || github.event.inputs.version }}"
          STATUS="${{ needs.build-and-release.result }}"

          if [ "$STATUS" = "success" ]; then
            echo "âœ… DMtools Agent Skill v$VERSION released successfully!"
            echo "ðŸ“¦ Available at: https://github.com/IstiN/dmtools-ai-docs/releases/tag/skill-v$VERSION"
            echo ""
            echo "Install with:"
            echo "curl -fsSL https://github.com/IstiN/dmtools-ai-docs/releases/download/skill-v$VERSION/install.sh | bash"
          else
            echo "âŒ Release failed for version $VERSION"
          fi