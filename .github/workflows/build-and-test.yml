name: Build and Test (Reusable)

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
    outputs:
      artifact_name:
        description: 'Name of the uploaded artifact'
        value: build-artifacts

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      checks: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java Environment
        uses: ./.github/actions/setup-java-only
        with:
          cache-key-suffix: '-unified-build'
      
      - name: Build All Artifacts (Single Build)
        id: gradle
        run: |
          ./gradlew clean build \
            :dmtools-core:shadowJar \
            :dmtools-server:bootJar \
            publish \
            -x integrationTest \
            -x :dmtools-automation:test \
            --no-daemon --info
        env:
          GITHUB_USERNAME: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: JUnit Tests (Unified Build)
          path: '**/build/test-results/test/TEST-*.xml'
          reporter: java-junit
          fail-on-error: true
      
      - name: Print Failed Tests
        if: failure()
        run: |
          echo "## :x: Test Failures or Build Issues" >> $GITHUB_STEP_SUMMARY
          
          # Check for failed test report files
          failed_tests_found=false
          echo "### Failed Test Cases" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in $(find . -name "TEST-*.xml"); do
            if grep -qE "(<failure|<error)" "$file"; then
              failed_tests_found=true
              TEST_CLASS=$(basename "$file" .xml | sed 's/TEST-//')
              echo "#### :test_tube: Test Class: \`$TEST_CLASS\`" >> $GITHUB_STEP_SUMMARY
              
              # Extract only failed testcase blocks using a stateful awk script
              awk '
                BEGIN { in_testcase=0; buffer="" }
                /<testcase / { in_testcase=1; buffer=$0; next; }
                /<\/testcase>/ {
                  if (in_testcase) {
                    buffer = buffer "\n" $0;
                    if (buffer ~ /<(failure|error)/) { print buffer; }
                    in_testcase=0; buffer="";
                  }
                  next;
                }
                { if (in_testcase) { buffer = buffer "\n" $0; } }
              ' "$file" > temp_failures.txt

              if [ -s temp_failures.txt ]; then
                  echo '```xml' >> $GITHUB_STEP_SUMMARY
                  # Decode HTML entities for better readability in GitHub Summary
                  sed -e 's/&lt;/</g' -e 's/&gt;/>/g' -e 's/&quot;/"/g' -e 's/&amp;/\&/g' -e "s/&apos;/'/g" temp_failures.txt >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
              fi
              rm -f temp_failures.txt
            fi
          done

          if [ "$failed_tests_found" = false ]; then
            echo "No specific test failures found in XML reports. The build might have failed for other reasons (e.g., compilation error, hung process)." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            build/reports/tests/test
            build/test-results/test
            dmtools-core/build/reports/tests/test
            dmtools-core/build/test-results/test
            dmtools-server/build/reports/tests/test
            dmtools-server/build/test-results/test
          retention-days: 7
      
      - name: Upload coverage reports to Codecov
        if: success() || steps.gradle.outcome == 'failure'
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results to Codecov
        if: success() || steps.gradle.outcome == 'failure'
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
      
      - name: Prepare Build Artifacts for Upload
        if: success()
        run: |
          mkdir -p build-artifacts
          
          # Copy CLI JAR
          cp dmtools-core/build/libs/dmtools-*-all.jar build-artifacts/ || echo "CLI JAR not found"
          
          # Copy Server JAR
          cp dmtools-server/build/libs/dmtools-server-*.jar build-artifacts/ || echo "Server JAR not found"
          
          # Copy scripts
          cp install.sh build-artifacts/
          cp dmtools.sh build-artifacts/
          
          # List artifacts
          echo "Build artifacts prepared:"
          ls -lh build-artifacts/
      
      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts/
          retention-days: 7

