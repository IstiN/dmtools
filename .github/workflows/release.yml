name: Release DMTools

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Custom version (e.g., 1.7.54). Leave empty to auto-increment patch version.'
        required: false
        type: string

jobs:
  version-and-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.new_version.outputs.version }}
      current_version: ${{ steps.current_version.outputs.current }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Read current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '^version=' gradle.properties | cut -d'=' -f2)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
      
      - name: Determine new version
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.current }}"
          CUSTOM_VERSION="${{ github.event.inputs.version }}"
          
          if [ -n "$CUSTOM_VERSION" ]; then
            NEW_VERSION="$CUSTOM_VERSION"
            echo "Using custom version: $NEW_VERSION"
          else
            # Auto-increment patch version
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"
            PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "Auto-incremented version: $NEW_VERSION"
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
      
      - name: Update gradle.properties
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          sed -i "s/^version=.*/version=$NEW_VERSION/" gradle.properties
          cat gradle.properties
      
      - name: Commit version change
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git add gradle.properties
          git commit -m "version increased to $NEW_VERSION"
      
      - name: Create tag
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git tag "v$NEW_VERSION"
          echo "Created tag: v$NEW_VERSION"
      
      - name: Push changes and tag
        run: |
          git push origin main
          git push origin --tags
      
      - name: Summary
        run: |
          echo "âœ… Version and tag created successfully!"
          echo "ðŸ“¦ Old version: ${{ steps.current_version.outputs.current }}"
          echo "ðŸš€ New version: ${{ steps.new_version.outputs.version }}"
          echo "ðŸ·ï¸  Tag: v${{ steps.new_version.outputs.version }}"
  
  # Single build job - compiles and tests once
  build-and-test:
    needs: version-and-tag
    uses: ./.github/workflows/build-and-test.yml
    secrets: inherit
    with:
      version: ${{ needs.version-and-tag.outputs.version }}
  
  # Parallel packaging jobs - no compilation, just packaging
  package-cli:
    needs: [version-and-tag, build-and-test]
    uses: ./.github/workflows/package-cli.yml
    secrets: inherit
    with:
      version: ${{ needs.version-and-tag.outputs.version }}

  # package-standalone:
  #   needs: [version-and-tag, build-and-test]
  #   uses: ./.github/workflows/package-standalone.yml
  #   secrets: inherit
  #   with:
  #     version: ${{ needs.version-and-tag.outputs.version }}
  #     flutter_release_tag: latest

  # Package AI skill
  package-skill:
    needs: [version-and-tag, build-and-test]
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update version in skill metadata
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"

          # Update version in SKILL.md metadata
          if [ -f "dmtools-ai-docs/SKILL.md" ]; then
            sed -i "s/version: .*/version: $VERSION/" dmtools-ai-docs/SKILL.md
          fi

      - name: Create skill package
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          DIST_DIR="dist"
          mkdir -p $DIST_DIR

          # Create the skill package
          echo "ðŸ“¦ Creating DMtools Agent Skill package..."
          cd dmtools-ai-docs

          # Create ZIP archive (exclude install.sh - it's a separate release asset)
          zip -r ../$DIST_DIR/dmtools-skill-v${VERSION}.zip . \
            -x "*.git*" \
            -x ".DS_Store" \
            -x "node_modules/*" \
            -x "*.swp" \
            -x ".cursorrules" \
            -x ".github/*" \
            -x "install.sh"

          # Create tarball for *nix systems (exclude install.sh - it's a separate release asset)
          tar -czf ../$DIST_DIR/dmtools-skill-v${VERSION}.tar.gz \
            --exclude='.git*' \
            --exclude='.DS_Store' \
            --exclude='node_modules' \
            --exclude='.cursorrules' \
            --exclude='.github' \
            --exclude='install.sh' \
            .

          cd ..

          # Copy install script
          cp dmtools-ai-docs/install.sh $DIST_DIR/skill-install.sh
          chmod +x $DIST_DIR/skill-install.sh

          echo "âœ… Skill package created:"
          ls -lh $DIST_DIR/

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.zip *.tar.gz > skill-checksums.sha256
          cat skill-checksums.sha256

      - name: Upload skill artifacts
        uses: actions/upload-artifact@v4
        with:
          name: skill-package
          path: |
            dist/dmtools-skill-*.zip
            dist/dmtools-skill-*.tar.gz
            dist/skill-install.sh
            dist/skill-checksums.sha256
          retention-days: 7

  # Create unified release with all artifacts
  create-unified-release:
    needs: [version-and-tag, package-cli, package-skill]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download CLI Package
        uses: actions/download-artifact@v4
        with:
          name: cli-package
          path: cli/

      - name: Download Skill Package
        uses: actions/download-artifact@v4
        with:
          name: skill-package
          path: skill/
      
      # - name: Download Standalone Package
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: standalone-package
      #     path: standalone/

      - name: List Downloaded Artifacts
        run: |
          echo "CLI artifacts:"
          ls -lhR cli/
          echo ""
          echo "Skill artifacts:"
          ls -lhR skill/
          # echo ""
          # echo "Standalone artifacts:"
          # ls -lhR standalone/
      
      - name: Generate Release Notes
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"

          # Get CLI JAR size
          CLI_JAR_SIZE=$(du -h cli/dmtools-v${VERSION}-all.jar | cut -f1)

          # Get Skill package sizes
          SKILL_ZIP_SIZE=$(du -h skill/dmtools-skill-v${VERSION}.zip | cut -f1)
          SKILL_TAR_SIZE=$(du -h skill/dmtools-skill-v${VERSION}.tar.gz | cut -f1)

          # Standalone artifacts disabled
          # STANDALONE_JAR_SIZE=$(du -h standalone/dmtools-standalone.jar | cut -f1)
          # STANDALONE_WAR_SIZE=$(du -h standalone/dmtools-standalone.war | cut -f1)
          # MACOS_ARM_SIZE=$(du -h standalone/bundles/dmtools-standalone-macos-aarch64.zip | cut -f1)
          # MACOS_X64_SIZE=$(du -h standalone/bundles/dmtools-standalone-macos-x64.zip | cut -f1)
          # WINDOWS_X64_SIZE=$(du -h standalone/bundles/dmtools-standalone-windows-x64.zip | cut -f1)
          # API_MACOS_ARM_SIZE=$(du -h standalone/api-bundles/dmtools-server-api-macos-aarch64.zip | cut -f1)
          # API_MACOS_X64_SIZE=$(du -h standalone/api-bundles/dmtools-server-api-macos-x64.zip | cut -f1)
          # API_WINDOWS_X64_SIZE=$(du -h standalone/api-bundles/dmtools-server-api-windows-x64.zip | cut -f1)

          cat > release_notes.md << EOF
          # ðŸš€ DMTools Release v${VERSION}

          This release includes the **DMTools CLI** and **Agent Skill** for AI assistants.

          ## ðŸ“¦ What's Included

          ### ðŸ–¥ï¸ DMTools CLI
          - **Command-line interface** for DMTools operations
          - **Java-based** automation and integration tools
          - **Cross-platform install scripts** for easy setup (\`install\`, \`install.sh\`, \`install.bat\`, \`install.ps1\`)
          - **Wrapper script** (\`dmtools.sh\`)

          ### ðŸ¤– DMTools Agent Skill
          - **Universal AI assistant skill** for Cursor, Claude, Codex, and other Agent Skills compatible systems
          - **Complete DMtools documentation** (67+ MCP tools, JavaScript agent development, configuration guides)
          - **Cross-platform support** (works with all major AI coding assistants)
          
          ## ðŸŽ¯ Quick Start

          ### Install DMTools CLI

          **macOS / Linux / Git Bash:**
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/IstiN/dmtools/main/install | bash
          \`\`\`

          **Windows (cmd.exe, PowerShell, Windows Terminal):**
          \`\`\`cmd
          curl -fsSL https://raw.githubusercontent.com/IstiN/dmtools/main/install.bat -o "%TEMP%\dmtools-install.bat" && "%TEMP%\dmtools-install.bat"
          \`\`\`

          ### Install DMTools Agent Skill

          **Automatic Installation (Recommended):**
          \`\`\`bash
          curl -fsSL https://github.com/IstiN/dmtools/releases/download/v${VERSION}/skill-install.sh | bash
          \`\`\`

          **Manual Installation:**
          1. Download \`dmtools-skill-v${VERSION}.zip\` or \`dmtools-skill-v${VERSION}.tar.gz\`
          2. Extract to one of these directories:
             - \`.cursor/skills/\` (project-level Cursor)
             - \`.claude/skills/\` (project-level Claude)
             - \`~/.cursor/skills/\` (global Cursor)
             - \`~/.claude/skills/\` (global Claude)
             - \`~/.codex/skills/\` (global Codex)

          ### Install Specific Version (v${VERSION})

          **DMTools CLI - macOS / Linux / Git Bash:**
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/IstiN/dmtools/v${VERSION}/install.sh | bash -s v${VERSION}
          \`\`\`

          **DMTools CLI - Windows (cmd.exe):**
          \`\`\`cmd
          set DMTOOLS_VERSION=v${VERSION} && curl -fsSL https://raw.githubusercontent.com/IstiN/dmtools/v${VERSION}/install.bat -o "%TEMP%\dmtools-install.bat" && "%TEMP%\dmtools-install.bat"
          \`\`\`

          **DMTools CLI - Windows (PowerShell):**
          \`\`\`powershell
          \$env:DMTOOLS_VERSION = "v${VERSION}"
          Invoke-RestMethod -Uri "https://raw.githubusercontent.com/IstiN/dmtools/v${VERSION}/install.ps1" | Invoke-Expression
          \`\`\`
          
          ## ðŸ“‹ System Requirements
          
          - **Java 23+** (required)
          - **2GB RAM** minimum, 4GB recommended
          - **1GB disk space** for application and data
          
          ## ðŸ“Š Build Information

          - **Version:** v${VERSION}
          - **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **CLI JAR Size:** ${CLI_JAR_SIZE}
          - **Skill ZIP Size:** ${SKILL_ZIP_SIZE}
          - **Skill TAR Size:** ${SKILL_TAR_SIZE}
          - **Git Commit:** \`${GITHUB_SHA:0:8}\`
          
          ## ðŸ› Troubleshooting
          
          ### Common Issues
          
          1. **Java version:** Ensure Java 23+ is installed (\`java -version\`)
          2. **Memory issues:** Increase heap size with \`-Xmx4g\`
          
          ### Getting Help
          
          - **Issues:** [GitHub Issues](https://github.com/IstiN/dmtools/issues)
          - **Documentation:** [Main Repository](https://github.com/IstiN/dmtools)
          EOF
          
          echo "Release notes generated"
      
      - name: Create Unified Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.version-and-tag.outputs.version }}
          name: "DMTools v${{ needs.version-and-tag.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            cli/dmtools-v${{ needs.version-and-tag.outputs.version }}-all.jar
            cli/install.sh
            cli/install
            cli/install.bat
            cli/install.ps1
            cli/dmtools.sh
            skill/dmtools-skill-v${{ needs.version-and-tag.outputs.version }}.zip
            skill/dmtools-skill-v${{ needs.version-and-tag.outputs.version }}.tar.gz
            skill/skill-install.sh
            skill/skill-checksums.sha256
      
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Unified Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.version-and-tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Version:** ${{ needs.version-and-tag.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts Included" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CLI Tools:**" >> $GITHUB_STEP_SUMMARY
          echo "- CLI JAR (dmtools-v${{ needs.version-and-tag.outputs.version }}-all.jar)" >> $GITHUB_STEP_SUMMARY
          echo "- install (cross-platform wrapper)" >> $GITHUB_STEP_SUMMARY
          echo "- install.sh (macOS/Linux)" >> $GITHUB_STEP_SUMMARY
          echo "- install.bat (Windows cmd.exe)" >> $GITHUB_STEP_SUMMARY
          echo "- install.ps1 (Windows PowerShell)" >> $GITHUB_STEP_SUMMARY
          echo "- dmtools.sh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Agent Skill:**" >> $GITHUB_STEP_SUMMARY
          echo "- Skill ZIP (dmtools-skill-v${{ needs.version-and-tag.outputs.version }}.zip)" >> $GITHUB_STEP_SUMMARY
          echo "- Skill TAR (dmtools-skill-v${{ needs.version-and-tag.outputs.version }}.tar.gz)" >> $GITHUB_STEP_SUMMARY
          echo "- skill-install.sh (automatic installer)" >> $GITHUB_STEP_SUMMARY
          echo "- skill-checksums.sha256 (checksums)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All artifacts compiled, tested, and packaged successfully!" >> $GITHUB_STEP_SUMMARY
