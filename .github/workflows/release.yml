name: Release DMTools

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Custom version (e.g., 1.7.54). Leave empty to auto-increment patch version.'
        required: false
        type: string

jobs:
  version-and-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.new_version.outputs.version }}
      current_version: ${{ steps.current_version.outputs.current }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Read current version
        id: current_version
        run: |
          CURRENT_VERSION=$(grep '^version=' gradle.properties | cut -d'=' -f2)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"
      
      - name: Determine new version
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.current }}"
          CUSTOM_VERSION="${{ github.event.inputs.version }}"
          
          if [ -n "$CUSTOM_VERSION" ]; then
            NEW_VERSION="$CUSTOM_VERSION"
            echo "Using custom version: $NEW_VERSION"
          else
            # Auto-increment patch version
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"
            PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "Auto-incremented version: $NEW_VERSION"
          fi
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
      
      - name: Update gradle.properties
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          sed -i "s/^version=.*/version=$NEW_VERSION/" gradle.properties
          cat gradle.properties
      
      - name: Commit version change
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git add gradle.properties
          git commit -m "version increased to $NEW_VERSION"
      
      - name: Create tag
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.version }}"
          git tag "v$NEW_VERSION"
          echo "Created tag: v$NEW_VERSION"
      
      - name: Push changes and tag
        run: |
          git push origin main
          git push origin --tags
      
      - name: Summary
        run: |
          echo "âœ… Version and tag created successfully!"
          echo "ðŸ“¦ Old version: ${{ steps.current_version.outputs.current }}"
          echo "ðŸš€ New version: ${{ steps.new_version.outputs.version }}"
          echo "ðŸ·ï¸  Tag: v${{ steps.new_version.outputs.version }}"
  
  # Single build job - compiles and tests once
  build-and-test:
    needs: version-and-tag
    uses: ./.github/workflows/build-and-test.yml
    secrets: inherit
    with:
      version: ${{ needs.version-and-tag.outputs.version }}
  
  # Parallel packaging jobs - no compilation, just packaging
  package-cli:
    needs: [version-and-tag, build-and-test]
    uses: ./.github/workflows/package-cli.yml
    secrets: inherit
    with:
      version: ${{ needs.version-and-tag.outputs.version }}
  
  # package-standalone:
  #   needs: [version-and-tag, build-and-test]
  #   uses: ./.github/workflows/package-standalone.yml
  #   secrets: inherit
  #   with:
  #     version: ${{ needs.version-and-tag.outputs.version }}
  #     flutter_release_tag: latest
  
  # Create unified release with all artifacts
  create-unified-release:
    needs: [version-and-tag, package-cli]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Download CLI Package
        uses: actions/download-artifact@v4
        with:
          name: cli-package
          path: cli/
      
      # - name: Download Standalone Package
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: standalone-package
      #     path: standalone/
      
      - name: List Downloaded Artifacts
        run: |
          echo "CLI artifacts:"
          ls -lhR cli/
          # echo ""
          # echo "Standalone artifacts:"
          # ls -lhR standalone/
      
      - name: Generate Release Notes
        run: |
          VERSION="${{ needs.version-and-tag.outputs.version }}"
          
          # Get CLI JAR size
          CLI_JAR_SIZE=$(du -h cli/dmtools-v${VERSION}-all.jar | cut -f1)
          
          # Standalone artifacts disabled
          # STANDALONE_JAR_SIZE=$(du -h standalone/dmtools-standalone.jar | cut -f1)
          # STANDALONE_WAR_SIZE=$(du -h standalone/dmtools-standalone.war | cut -f1)
          # MACOS_ARM_SIZE=$(du -h standalone/bundles/dmtools-standalone-macos-aarch64.zip | cut -f1)
          # MACOS_X64_SIZE=$(du -h standalone/bundles/dmtools-standalone-macos-x64.zip | cut -f1)
          # WINDOWS_X64_SIZE=$(du -h standalone/bundles/dmtools-standalone-windows-x64.zip | cut -f1)
          # API_MACOS_ARM_SIZE=$(du -h standalone/api-bundles/dmtools-server-api-macos-aarch64.zip | cut -f1)
          # API_MACOS_X64_SIZE=$(du -h standalone/api-bundles/dmtools-server-api-macos-x64.zip | cut -f1)
          # API_WINDOWS_X64_SIZE=$(du -h standalone/api-bundles/dmtools-server-api-windows-x64.zip | cut -f1)
          
          cat > release_notes.md << EOF
          # ðŸš€ DMTools CLI Release v${VERSION}
          
          This release includes the **DMTools CLI** for command-line operations.
          
          ## ðŸ“¦ What's Included
          
          ### ðŸ–¥ï¸ DMTools CLI
          - **Command-line interface** for DMTools operations
          - **Java-based** automation and integration tools
          - **Cross-platform install scripts** for easy setup (\`install\`, \`install.sh\`, \`install.bat\`, \`install.ps1\`)
          - **Wrapper script** (\`dmtools.sh\`)
          
          ## ðŸŽ¯ Quick Start

          ### Install Latest Version

          **macOS / Linux / Git Bash:**
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/IstiN/dmtools/main/install | bash
          \`\`\`

          **Windows (cmd.exe, PowerShell, Windows Terminal):**
          \`\`\`cmd
          curl -fsSL https://raw.githubusercontent.com/IstiN/dmtools/main/install.bat -o "%TEMP%\dmtools-install.bat" && "%TEMP%\dmtools-install.bat"
          \`\`\`

          ### Install This Specific Version (v${VERSION})

          **macOS / Linux / Git Bash:**
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/IstiN/dmtools/v${VERSION}/install.sh | bash -s v${VERSION}
          \`\`\`

          **Windows (cmd.exe):**
          \`\`\`cmd
          set DMTOOLS_VERSION=v${VERSION} && curl -fsSL https://raw.githubusercontent.com/IstiN/dmtools/v${VERSION}/install.bat -o "%TEMP%\dmtools-install.bat" && "%TEMP%\dmtools-install.bat"
          \`\`\`

          **Windows (PowerShell):**
          \`\`\`powershell
          \$env:DMTOOLS_VERSION = "v${VERSION}"
          Invoke-RestMethod -Uri "https://raw.githubusercontent.com/IstiN/dmtools/v${VERSION}/install.ps1" | Invoke-Expression
          \`\`\`
          
          **Manual download:**
          \`\`\`bash
          # Download dmtools-v${VERSION}-all.jar manually and use dmtools.sh
          \`\`\`
          
          ## ðŸ“‹ System Requirements
          
          - **Java 23+** (required)
          - **2GB RAM** minimum, 4GB recommended
          - **1GB disk space** for application and data
          
          ## ðŸ“Š Build Information
          
          - **Version:** v${VERSION}
          - **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **CLI JAR Size:** ${CLI_JAR_SIZE}
          - **Git Commit:** \`${GITHUB_SHA:0:8}\`
          
          ## ðŸ› Troubleshooting
          
          ### Common Issues
          
          1. **Java version:** Ensure Java 23+ is installed (\`java -version\`)
          2. **Memory issues:** Increase heap size with \`-Xmx4g\`
          
          ### Getting Help
          
          - **Issues:** [GitHub Issues](https://github.com/IstiN/dmtools/issues)
          - **Documentation:** [Main Repository](https://github.com/IstiN/dmtools)
          EOF
          
          echo "Release notes generated"
      
      - name: Create Unified Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.version-and-tag.outputs.version }}
          name: "DMTools v${{ needs.version-and-tag.outputs.version }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            cli/dmtools-v${{ needs.version-and-tag.outputs.version }}-all.jar
            cli/install.sh
            cli/install
            cli/install.bat
            cli/install.ps1
            cli/dmtools.sh
      
      - name: Summary
        run: |
          echo "## ðŸŽ‰ Unified Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.version-and-tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Previous Version:** ${{ needs.version-and-tag.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts Included" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**CLI Tools:**" >> $GITHUB_STEP_SUMMARY
          echo "- CLI JAR (dmtools-v${{ needs.version-and-tag.outputs.version }}-all.jar)" >> $GITHUB_STEP_SUMMARY
          echo "- install (cross-platform wrapper)" >> $GITHUB_STEP_SUMMARY
          echo "- install.sh (macOS/Linux)" >> $GITHUB_STEP_SUMMARY
          echo "- install.bat (Windows cmd.exe)" >> $GITHUB_STEP_SUMMARY
          echo "- install.ps1 (Windows PowerShell)" >> $GITHUB_STEP_SUMMARY
          echo "- dmtools.sh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… CLI artifacts compiled, tested, and packaged successfully!" >> $GITHUB_STEP_SUMMARY
