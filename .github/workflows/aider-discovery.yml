name: Aider Discovery Phase

on:
  workflow_dispatch:
    inputs:
      user_request:
        description: 'User request for file discovery (will be base64 encoded automatically)'
        required: true
        type: string
      model:
        description: 'Gemini model to use'
        required: false
        type: choice
        options:
          - 'gemini/gemini-2.5-flash-preview-05-20'
          - 'gemini/gemini-1.5-pro-latest'
          - 'gemini/gemini-1.5-flash-latest'
        default: 'gemini/gemini-2.5-flash-preview-05-20'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  discovery:
    runs-on: ubuntu-latest
    outputs:
      discovery_found: ${{ steps.aider_run.outputs.response_found }}
      discovery_response: ${{ steps.aider_run.outputs.aider_response }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Run Aider Discovery Analysis
      id: aider_run
      uses: ./.github/actions/aider-setup
      with:
        user_request: ${{ github.event.inputs.user_request }}
        model: ${{ github.event.inputs.model }}
        gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
        prompt_file: 'aider/discovery-prompt.md'
        mode: 'analysis'

    - name: Create discovery summary artifact  
      env:
        DISCOVERY_RESPONSE: ${{ steps.aider_run.outputs.aider_response }}
      run: |
        # Create dedicated summary file for discovery results
        mkdir -p aider-outputs/discovery-summary
        
        if [ "${{ steps.aider_run.outputs.response_found }}" = "true" ] && [ ! -z "$DISCOVERY_RESPONSE" ]; then
          echo "✅ Creating discovery summary"
          
          # Save the discovery summary
          echo "$DISCOVERY_RESPONSE" > aider-outputs/discovery-summary/discovery-analysis.md
          
          echo "📝 Discovery summary created successfully"
          echo "Summary size: $(wc -c < aider-outputs/discovery-summary/discovery-analysis.md) bytes"
          
        else
          echo "❌ No discovery response generated"
          echo "# Discovery Failed" > aider-outputs/discovery-summary/discovery-analysis.md
          echo "" >> aider-outputs/discovery-summary/discovery-analysis.md
          echo "The discovery phase did not generate a valid response." >> aider-outputs/discovery-summary/discovery-analysis.md
          echo "Please check the execution logs for errors." >> aider-outputs/discovery-summary/discovery-analysis.md
        fi

    - name: Upload discovery artifacts
      uses: actions/upload-artifact@v4
      with:
        name: aider-discovery-logs-${{ github.run_number }}
        path: |
          aider-outputs/response_*.txt
          aider-outputs/affected-files*.json
        retention-days: 7

    - name: Upload discovery summary
      uses: actions/upload-artifact@v4
      with:
        name: discovery-summary-${{ github.run_number }}
        path: aider-outputs/discovery-summary/
        retention-days: 7

    - name: Display discovery summary
      env:
        DISCOVERY_RESPONSE: ${{ steps.aider_run.outputs.aider_response }}
      run: |
        echo "## 🔍 Discovery Phase Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status**: ${{ steps.aider_run.outputs.response_found == 'true' && '✅ Success' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Model**: ${{ github.event.inputs.model }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Include discovery results if available
        if [ "${{ steps.aider_run.outputs.response_found }}" = "true" ]; then
          echo "### 📊 Discovery Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$DISCOVERY_RESPONSE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🚀 Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the discovery analysis above" >> $GITHUB_STEP_SUMMARY
          echo "2. Download the \`affected-files.json\` from artifacts" >> $GITHUB_STEP_SUMMARY
          echo "3. Run the **Implementation Phase** workflow with the same request" >> $GITHUB_STEP_SUMMARY
          echo "4. The implementation phase will use the discovered file list" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ❌ Discovery Failed" >> $GITHUB_STEP_SUMMARY
          echo "Please check the execution logs and try again." >> $GITHUB_STEP_SUMMARY
        fi
