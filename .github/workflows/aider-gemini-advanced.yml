name: Aider Code Assistant (Gemini Advanced)

on:
  workflow_dispatch:
    inputs:
      user_request:
        description: 'Your request for Aider'
        required: true
        type: string
      target_files:
        description: 'Files to include in context (comma-separated, optional)'
        required: false
        type: string
        default: ''
      model:
        description: 'Google Gemini model to use'
        required: false
        type: choice
        default: 'gemini/gemini-2.5-flash-preview-05-20'
        options:
          - gemini/gemini-2.5-flash-preview-05-20
          - gemini/gemini-1.5-pro-latest
          - gemini/gemini-1.5-pro-002
          - gemini/gemini-1.5-flash-latest
          - gemini/gemini-1.5-flash-002
          - gemini/gemini-1.0-pro-latest
      gemini_api_key_secret:
        description: 'GitHub secret name containing Gemini API key'
        required: false
        type: string
        default: 'GEMINI_API_KEY'
      max_tokens:
        description: 'Maximum tokens for context (Gemini 1.5 Pro supports up to 1M+)'
        required: false
        type: number
        default: 1000000
      create_pr:
        description: 'Create a pull request with changes'
        required: false
        type: boolean
        default: false
      auto_commit:
        description: 'Auto-commit changes without creating PR'
        required: false
        type: boolean
        default: false
      include_tests:
        description: 'Include test files in context'
        required: false
        type: boolean
        default: true

jobs:
  run-aider:
    runs-on: ubuntu-latest
    
    outputs:
      changes_detected: ${{ steps.check_changes.outputs.changes }}
      pr_number: ${{ steps.create_pr.outputs.pull-request-number }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-aider-gemini-advanced-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-aider-gemini-advanced-
          ${{ runner.os }}-pip-aider-

    - name: Cache Aider installation
      uses: actions/cache@v4
      with:
        path: |
          ~/.local/bin/aider
          ~/.local/share/aider
          ~/.cache/aider
          ~/.aider
        key: ${{ runner.os }}-aider-advanced-v085-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-aider-advanced-v085-
          ${{ runner.os }}-aider-advanced-
          ${{ runner.os }}-aider-install-
          ${{ runner.os }}-aider-

    - name: Cache Aider repo index
      uses: actions/cache@v4
      with:
        path: |
          .aider*
          .aider.repo.map
          .aider.tags
        key: ${{ runner.os }}-aider-repo-advanced-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-aider-repo-advanced-
          ${{ runner.os }}-aider-repo-

    - name: Install Aider and dependencies
      run: |
        pip install --upgrade pip
        
        # Check if aider is already cached and working
        if command -v aider >/dev/null 2>&1 && aider --version >/dev/null 2>&1; then
          echo "‚úÖ Aider found in cache and working, skipping installation"
          aider --version
          INSTALL_AIDER=false
        else
          echo "üì¶ Aider not found in cache or not working, installing..."
          INSTALL_AIDER=true
        fi
        
        # Install Aider if needed
        if [ "$INSTALL_AIDER" = "true" ]; then
          echo "üîß Installing Aider using recommended method..."
          pip install aider-install
          aider-install
          
          # Verify new installation
          echo "üîç Verifying new Aider installation..."
          aider --version
          echo "‚úÖ Aider installation verified"
        fi
        
        # Install additional dependencies
        pip install google-generativeai
        pip install PyYAML
        pip install gitpython

    - name: Create custom Gemini configuration
      run: |
        cat > .aider.conf.yml << EOF
        model: ${{ inputs.model }}
        edit-format: whole
        max-chat-history-tokens: ${{ inputs.max_tokens }}
        cache-prompts: true
        stream: false
        pretty: false
        show-diffs: true
        auto-commits: ${{ inputs.auto_commit }}
        yes-always: true
        EOF

    - name: Create output directories
      run: |
        mkdir -p aider-outputs
        mkdir -p aider

    - name: Validate Gemini API Key
      run: |
        # Check if the API key secret exists (indirect check)
        if [ -z "${{ secrets[inputs.gemini_api_key_secret] }}" ] && [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
          echo "ERROR: No Gemini API key found. Please set up GEMINI_API_KEY secret or specify custom secret name."
          exit 1
        fi
        echo "‚úÖ Gemini API key validation passed"

    - name: Analyze repository structure
      env:
        USER_REQUEST_RAW: ${{ inputs.user_request }}
      run: |
        echo "üìä Repository Analysis" > aider-outputs/repo_analysis.md
        echo "===================" >> aider-outputs/repo_analysis.md
        echo "" >> aider-outputs/repo_analysis.md
        echo "### File Count by Type" >> aider-outputs/repo_analysis.md
        find . -type f -name "*.java" | wc -l | xargs echo "Java files:" >> aider-outputs/repo_analysis.md
        find . -type f -name "*.js" | wc -l | xargs echo "JavaScript files:" >> aider-outputs/repo_analysis.md
        find . -type f -name "*.yml" -o -name "*.yaml" | wc -l | xargs echo "YAML files:" >> aider-outputs/repo_analysis.md
        find . -type f -name "*.md" | wc -l | xargs echo "Markdown files:" >> aider-outputs/repo_analysis.md
        echo "" >> aider-outputs/repo_analysis.md
        echo "### Repository Size" >> aider-outputs/repo_analysis.md
        du -sh . | awk '{print "Total size: " $1}' >> aider-outputs/repo_analysis.md
        echo "" >> aider-outputs/repo_analysis.md
        
        # Write user input to file using base64 encoding to prevent ALL shell interpretation
        echo "$USER_REQUEST_RAW" | base64 > aider-outputs/user_request_b64.txt
        echo "üíæ Stored user request safely (base64 encoded)"

    - name: Run Aider with enhanced Gemini configuration
      env:
        # Support multiple API key configurations
        GEMINI_API_KEY: ${{ secrets[inputs.gemini_api_key_secret] || secrets.GEMINI_API_KEY }}
        GOOGLE_API_KEY: ${{ secrets[inputs.gemini_api_key_secret] || secrets.GEMINI_API_KEY }}
        GOOGLE_GEMINI_API_KEY: ${{ secrets[inputs.gemini_api_key_secret] || secrets.GEMINI_API_KEY }}
      run: |
        # Set timestamp and create output files
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        OUTPUT_FILE="aider-outputs/response_${TIMESTAMP}.txt"
        METRICS_FILE="aider-outputs/metrics_${TIMESTAMP}.json"
        
        # Create metrics file
        cat > "$METRICS_FILE" << EOF
        {
          "timestamp": "$TIMESTAMP",
          "model": "${{ inputs.model }}",
          "max_tokens": ${{ inputs.max_tokens }},
          "request": "${{ inputs.user_request }}",
          "target_files": "${{ inputs.target_files }}",
          "include_tests": ${{ inputs.include_tests }},
          "create_pr": ${{ inputs.create_pr }},
          "auto_commit": ${{ inputs.auto_commit }},
          "github_run_id": "${{ github.run_id }}",
          "github_run_number": "${{ github.run_number }}",
          "repository": "${{ github.repository }}"
        }
        EOF
        
        # Prepare the enhanced command with optimization flags
        AIDER_CMD="aider"
        AIDER_CMD="$AIDER_CMD --model ${{ inputs.model }}"
        AIDER_CMD="$AIDER_CMD --max-chat-history-tokens ${{ inputs.max_tokens }}"
        AIDER_CMD="$AIDER_CMD --subtree-only --no-check-update --no-suggest-shell-commands --yes-always --no-stream --no-pretty"
        
        # Add target files if specified
        if [ -n "${{ inputs.target_files }}" ]; then
          IFS=',' read -ra FILES <<< "${{ inputs.target_files }}"
          for file in "${FILES[@]}"; do
            file=$(echo "$file" | xargs)  # Trim whitespace
            if [ -f "$file" ]; then
              AIDER_CMD="$AIDER_CMD \"$file\""
              echo "‚úÖ Including file: $file"
            else
              echo "‚ö†Ô∏è  Warning: File '$file' not found" | tee -a "$OUTPUT_FILE"
            fi
          done
        else
          # Auto-include relevant files based on project type
          echo "üîç Auto-detecting project files..."
          
          # Include main source files
          if [ -d "src" ]; then
            AIDER_CMD="$AIDER_CMD src/"
          fi
          
          # Include configuration files
          for config_file in "build.gradle" "package.json" "requirements.txt" "pom.xml" ".aider.conf.yml"; do
            if [ -f "$config_file" ]; then
              AIDER_CMD="$AIDER_CMD \"$config_file\""
            fi
          done
          
          # Include test files if requested
          if [ "${{ inputs.include_tests }}" == "true" ]; then
            for test_dir in "tests" "test" "spec"; do
              if [ -d "$test_dir" ]; then
                AIDER_CMD="$AIDER_CMD $test_dir/"
              fi
            done
          fi
        fi
        
        # Enhanced request with response tag instruction (no file creation)
        # Prepare the message (safely handle special characters)
        echo "=== PREPARING AIDER MESSAGE ===" | tee -a "$OUTPUT_FILE"
        
        # Read and decode user request from base64 to handle ANY characters safely
        USER_REQUEST=$(base64 -d < aider-outputs/user_request_b64.txt)
        
        # Build the message using printf to safely handle all special characters  
        printf -v SAFE_MESSAGE 'Repository: %s (large codebase). Request: %s. CRITICAL INSTRUCTIONS: 1) You are doing ANALYSIS ONLY - NO CODE GENERATION OR CHANGES. 2) DO NOT modify, create, or edit any files except ONE: create a file called "aider-outputs/analysis-response.md" with your complete response. 3) ONLY READ and analyze existing code. 4) Work autonomously - read any files you need without asking. 5) Write your COMPLETE analysis response to "aider-outputs/analysis-response.md" AND also output it wrapped between these exact tags: <AIDER_RESPONSE_START> and <AIDER_RESPONSE_END>. 6) Your response must be in markdown format with all diagrams and explanations. 7) Focus on solution design based on existing codebase analysis. 8) Use the exact response format template provided in the request.' "${{ github.repository }}" "$USER_REQUEST"
        
        # Execute with comprehensive logging
        {
          echo "üöÄ === AIDER GEMINI EXECUTION START ==="
          echo "üïê Timestamp: $TIMESTAMP"
          echo "ü§ñ Model: ${{ inputs.model }}"
          echo "üß† Max Tokens: ${{ inputs.max_tokens }}"
          echo "üìù Request: ${{ inputs.user_request }}"
          echo "üìÅ Target Files: ${{ inputs.target_files || 'Auto-detected' }}"
          echo "üß™ Include Tests: ${{ inputs.include_tests }}"
          echo "üîÄ Create PR: ${{ inputs.create_pr }}"
          echo "üíæ Auto Commit: ${{ inputs.auto_commit }}"
          echo "‚öôÔ∏è  Command: $AIDER_CMD"
          echo ""
          echo "üìã === CONFIGURATION ==="
          cat .aider.conf.yml
          echo ""
          echo "üí¨ === AIDER RESPONSE ==="
          
          # Create message file to avoid any shell injection issues
          echo "$SAFE_MESSAGE" > aider-outputs/message.txt
          
          # Run aider with message file and capture both stdout and stderr
          eval "$AIDER_CMD --message-file aider-outputs/message.txt" 2>&1
          
          echo ""
          echo "‚úÖ === AIDER EXECUTION END ==="
        } | tee "$OUTPUT_FILE"
        
        # Extract response from output using tags
        echo "üîç Extracting response from Aider output..." | tee -a "$OUTPUT_FILE"
        
        # Parse response between tags
        if grep -q "<AIDER_RESPONSE_START>" "$OUTPUT_FILE" && grep -q "<AIDER_RESPONSE_END>" "$OUTPUT_FILE"; then
          echo "‚úÖ Response tags found in output" | tee -a "$OUTPUT_FILE"
          
          # Extract content between tags to variable and file
          EXTRACTED_RESPONSE=$(sed -n '/<AIDER_RESPONSE_START>/,/<AIDER_RESPONSE_END>/p' "$OUTPUT_FILE" | sed '1d;$d')
          echo "$EXTRACTED_RESPONSE" > "aider-outputs/aider-response.md"
          
          # Verify extraction
          if [ -f "aider-outputs/aider-response.md" ] && [ -s "aider-outputs/aider-response.md" ]; then
            RESPONSE_SIZE=$(wc -c < "aider-outputs/aider-response.md")
            echo "‚úÖ Response extracted successfully (size: $RESPONSE_SIZE bytes)" | tee -a "$OUTPUT_FILE"
            
            # Store response for summary (escape for GitHub Actions)
            echo "AIDER_RESPONSE<<EOF" >> $GITHUB_ENV
            echo "$EXTRACTED_RESPONSE" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "RESPONSE_FOUND=true" >> $GITHUB_ENV
            
            # Show first and last few lines for verification in logs
            echo "üîç First 3 lines of extracted response:" | tee -a "$OUTPUT_FILE"
            echo "$EXTRACTED_RESPONSE" | head -3 | tee -a "$OUTPUT_FILE"
            echo "üîç Last 3 lines of extracted response:" | tee -a "$OUTPUT_FILE"
            echo "$EXTRACTED_RESPONSE" | tail -3 | tee -a "$OUTPUT_FILE"
          else
            echo "‚ùå Failed to extract response content" | tee -a "$OUTPUT_FILE"
            echo "RESPONSE_FOUND=false" >> $GITHUB_ENV
          fi
        else
          echo "‚ö†Ô∏è Response tags not found in output" | tee -a "$OUTPUT_FILE"
          echo "üîç Searching for partial tags..." | tee -a "$OUTPUT_FILE"
          grep -n "AIDER_RESPONSE" "$OUTPUT_FILE" | tee -a "$OUTPUT_FILE" || echo "No AIDER_RESPONSE tags found at all" | tee -a "$OUTPUT_FILE"
          echo "RESPONSE_FOUND=false" >> $GITHUB_ENV
        fi
        
        # Save output file paths
        echo "OUTPUT_FILE=$OUTPUT_FILE" >> $GITHUB_ENV
        echo "METRICS_FILE=$METRICS_FILE" >> $GITHUB_ENV

    - name: Check for code changes
      id: check_changes
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Code changes detected"
          
          # Show what changed
          echo "üìù Changed files:" >> aider-outputs/changes_summary.txt
          git status --porcelain >> aider-outputs/changes_summary.txt
          echo "" >> aider-outputs/changes_summary.txt
          echo "üìä Diff summary:" >> aider-outputs/changes_summary.txt
          git diff --stat >> aider-outputs/changes_summary.txt
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è  No code changes detected"
        fi

    - name: Auto-commit changes
      if: inputs.auto_commit && steps.check_changes.outputs.changes == 'true' && !inputs.create_pr
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action (Aider)"
        git add .
        git commit -m "ü§ñ Aider: ${{ inputs.user_request }}

        Executed by: ${{ github.actor }}
        Workflow: ${{ github.workflow }}
        Run: ${{ github.run_number }}
        Model: ${{ inputs.model }}"
        git push

    - name: Create Pull Request
      id: create_pr
      if: inputs.create_pr && steps.check_changes.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ü§ñ Aider: ${{ inputs.user_request }}"
        title: "ü§ñ Aider Gemini: ${{ inputs.user_request }}"
        body: |
          ## ü§ñ Aider Code Assistant Changes (Gemini)
          
          **üéØ Request:** ${{ inputs.user_request }}  
          **ü§ñ Model:** ${{ inputs.model }}  
          **üß† Max Tokens:** ${{ inputs.max_tokens }}  
          **üìÅ Target Files:** ${{ inputs.target_files || 'Auto-detected' }}  
          **üß™ Include Tests:** ${{ inputs.include_tests }}  
          **üë§ Executed by:** @${{ github.actor }}  
          
          ### üìä Execution Details
          - **Workflow Run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Repository:** ${{ github.repository }}
          - **Branch:** ${{ github.ref_name }}
          
          ### üîÑ Changes Made
          This PR contains changes automatically generated by Aider using Google Gemini models in response to the above request.
          
          Please review the changes carefully before merging.
          
          ---
          *Generated by [Aider Gemini Advanced Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
        branch: aider-gemini/request-${{ github.run_number }}
        delete-branch: true
        labels: |
          aider
          ai-generated
          gemini

    - name: Upload execution logs
      uses: actions/upload-artifact@v4
      with:
        name: aider-execution-logs-${{ github.run_number }}
        path: |
          aider-outputs/response_*.txt
        retention-days: 7

    - name: Display Aider response
      run: |
        # Display the raw Aider response first (no headers) - v2
        if [ "$RESPONSE_FOUND" = "true" ] && [ -f "aider-outputs/aider-response.md" ]; then
          echo "$AIDER_RESPONSE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
          echo "## üìù Changes Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f "aider-outputs/changes_summary.txt" ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat aider-outputs/changes_summary.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.create_pr }}" == "true" ] && [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
            echo "## üîÄ Pull Request Created" >> $GITHUB_STEP_SUMMARY
            echo "**PR #${{ steps.create_pr.outputs.pull-request-number }}** has been created with the changes." >> $GITHUB_STEP_SUMMARY
            echo "[View Pull Request](${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.create_pr.outputs.pull-request-number }})" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "## ‚ÑπÔ∏è No Changes" >> $GITHUB_STEP_SUMMARY
          echo "Aider completed successfully but no code changes were made." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        

