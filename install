#!/usr/bin/env bash
# DMTools CLI Cross-Platform Installation Wrapper
# Usage: curl https://github.com/IstiN/dmtools/releases/latest/download/install | bash
# This script auto-detects the platform and runs the appropriate installer
# Works even if this file doesn't exist in older releases - falls back to install.sh

set -e

REPO="IstiN/dmtools"

# Get download URL for a specific asset from GitHub release using API
get_asset_url() {
    local tag="$1"
    local asset_name="$2"
    
    # Try latest release API
    local api_url="https://api.github.com/repos/${REPO}/releases/latest"
    local release_info=$(curl -s --connect-timeout 10 --max-time 30 "${api_url}" 2>/dev/null)
    
    if [ -n "$release_info" ] && ! echo "$release_info" | grep -q '"message":"Not Found"'; then
        # Try to extract download URL using grep and sed (works without jq)
        local download_url=$(echo "$release_info" | grep -o "\"browser_download_url\":\"[^\"]*${asset_name}[^\"]*\"" | head -1 | sed 's/.*"browser_download_url":"\([^"]*\)".*/\1/')
        if [ -n "$download_url" ] && [ "$download_url" != "null" ]; then
            echo "$download_url"
            return 0
        fi
    fi
    
    return 1
}

# Download and validate script before executing
download_and_run() {
    local url="$1"
    local temp_file=$(mktemp /tmp/dmtools-install-XXXXXX.sh 2>/dev/null || mktemp /tmp/dmtools-install-XXXXXX.sh)
    
    # Download to temp file
    if command -v curl >/dev/null 2>&1; then
        if ! curl -fsSL "$url" -o "$temp_file" 2>/dev/null; then
            rm -f "$temp_file" 2>/dev/null
            return 1
        fi
    elif command -v wget >/dev/null 2>&1; then
        if ! wget -qO "$temp_file" "$url" 2>/dev/null; then
            rm -f "$temp_file" 2>/dev/null
            return 1
        fi
    else
        echo "Error: Neither curl nor wget is available."
        return 1
    fi
    
    # Check if downloaded file is a valid script (not HTML error page)
    if [ ! -s "$temp_file" ] || head -1 "$temp_file" 2>/dev/null | grep -qiE "(html|<!doctype|not found|404|github)" 2>/dev/null; then
        rm -f "$temp_file" 2>/dev/null
        return 1
    fi
    
    # Make executable and run
    chmod +x "$temp_file" 2>/dev/null
    bash "$temp_file"
    local exit_code=$?
    rm -f "$temp_file" 2>/dev/null
    return $exit_code
}

# Detect platform and shell
detect_platform() {
    # Check if we're in Git Bash or WSL on Windows
    if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]] || [[ -n "$WINDIR" ]] || [[ -n "$MSYSTEM" ]]; then
        echo "windows-bash"
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        echo "linux"
    else
        echo "unknown"
    fi
}

# Download and run installer
run_installer() {
    local platform=$(detect_platform)
    
    case "$platform" in
        windows-bash|macos|linux)
            echo "Detected ${platform} - downloading installer..."
            
            # Always try install.sh first (it exists in all releases)
            # Try to get install.sh URL from GitHub API
            local install_url=$(get_asset_url "latest" "install.sh")
            
            # If API method failed, try direct URL
            if [ -z "$install_url" ]; then
                install_url="https://github.com/${REPO}/releases/latest/download/install.sh"
            fi
            
            # Download and run install.sh
            if download_and_run "$install_url"; then
                return 0
            fi
            
            # If that failed, try with a specific version pattern
            echo "Trying alternative download method..."
            install_url="https://github.com/${REPO}/releases/latest/download/install.sh"
            if download_and_run "$install_url"; then
                return 0
            fi
            
            echo ""
            echo "Error: Failed to download installer script."
            echo ""
            echo "Please try one of these methods:"
            echo ""
            echo "1. Direct download (recommended):"
            echo "   curl -fsSL https://github.com/${REPO}/releases/latest/download/install.sh | bash"
            echo ""
            echo "2. Or download manually from:"
            echo "   https://github.com/${REPO}/releases/latest"
            exit 1
            ;;
        *)
            echo "Error: Unsupported platform: $OSTYPE"
            echo "Please use the platform-specific installer:"
            echo "  macOS/Linux: curl -fsSL https://github.com/${REPO}/releases/latest/download/install.sh | bash"
            echo "  Windows PowerShell: Invoke-RestMethod -Uri 'https://github.com/${REPO}/releases/latest/download/install.ps1' | Invoke-Expression"
            exit 1
            ;;
    esac
}

# Main
run_installer
