<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - DMTools</title>
    <link rel="icon" href="img/dmtools-icon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="styleguide/styleguide.css">
    
    <!-- Monaco Editor for JavaScript editing -->
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <style>
        .settings-navigation {
            background-color: var(--bg-color, #eee);
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 5px;
            border: 1px solid var(--border-color, #ddd);
        }
        .settings-navigation h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2em;
            color: var(--text-secondary, #444);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .settings-navigation ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .settings-navigation ul li a {
            text-decoration: none;
            color: var(--accent-color, #007bff);
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .settings-navigation ul li a:hover,
        .settings-navigation ul li a.active {
            background-color: var(--hover-bg, #e6f2ff);
            text-decoration: none;
        }
        .back-to-dashboard-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: var(--text-secondary, #666);
            margin-bottom: 15px;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }
        .back-to-dashboard-link:hover {
            background-color: var(--hover-bg, #f0f0f0);
            text-decoration: none;
        }
        .settings-form {
            background-color: var(--card-bg, #f9f9f9);
            border: 1px solid var(--border-color, #eee);
            border-radius: 5px;
            overflow: hidden;
        }
        .settings-form details {
            border-bottom: 1px solid var(--border-color, #ddd);
        }
        .settings-form details:last-child {
            border-bottom: none;
        }
        .settings-form summary {
            background-color: var(--hover-bg, #f8f9fa);
            padding: 15px 20px;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-color, #333);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s ease;
        }
        .settings-form summary:hover {
            background-color: var(--accent-color, #007bff);
            color: white;
        }
        .settings-form details[open] summary {
            background-color: var(--accent-color, #007bff);
            color: white;
            border-bottom: 1px solid var(--border-color, #ddd);
        }
        .settings-form details > div {
            padding: 20px;
            background-color: var(--card-bg, #fff);
        }
        .settings-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-color, #333);
        }
        .settings-form input[type="text"],
        .settings-form input[type="password"],
        .settings-form input[type="number"],
        .settings-form select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color, #ddd);
            border-radius: 4px;
            background-color: var(--card-bg, #fff);
            color: var(--text-color, #333);
            font-size: 14px;
            box-sizing: border-box;
        }
        .settings-form input:focus,
        .settings-form select:focus {
            outline: none;
            border-color: var(--accent-color, #007bff);
            box-shadow: 0 0 0 2px rgba(70, 106, 241, 0.2);
        }
        .hint {
            font-size: 0.85em;
            color: var(--text-secondary, #666);
            margin-bottom: 15px;
            line-height: 1.4;
        }
        .settings-submit-btn {
            background-color: var(--accent-color, #007bff);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s ease;
        }
        .settings-submit-btn:hover {
            background-color: var(--accent-hover, #0056b3);
        }
        #dynamic-metrics-fields {
            margin-top: 15px;
        }
        #dynamic-metrics-fields label {
            margin-top: 10px;
        }
    </style>
</head>
<body class="sg-body">
    <div class="sg-container">
        <header class="sg-header">
            <a href="/"><img src="img/dmtools-logo-intelligent-network-fusion-white.svg" alt="DMTools Logo" style="height: 50px; margin-bottom: 10px;"></a>
            <p>Configure your DMTools application settings and integrations.</p>
            <button id="theme-toggle" class="theme-switch global-theme-switcher" aria-label="Toggle theme">
                <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-weight="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
            </button>
        </header>

        <div id="stop-server-container" style="display: none; position: fixed; top: 10px; right: 10px; z-index: 1000;">
            <button onclick="stopServer()" class="sg-button sg-button--danger">Stop Server</button>
        </div>

        <nav class="settings-navigation">
            <a href="index.html" class="back-to-dashboard-link">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Dashboard</span>
            </a>
            <h2><i class="fas fa-cog"></i> Configuration Sections</h2>
            <ul>
                <li><a href="#section-confluence" class="active"><i class="fas fa-file-alt"></i> Confluence</a></li>
                <li><a href="#section-openai"><i class="fas fa-brain"></i> OpenAI</a></li>
                <li><a href="#section-gemini"><i class="fas fa-gem"></i> Gemini AI</a></li>
                <li><a href="#section-jsai"><i class="fas fa-code"></i> JS AI Client</a></li>
                <li><a href="#section-bitbucket"><i class="fab fa-bitbucket"></i> Bitbucket</a></li>
                <li><a href="#section-jira"><i class="fab fa-jira"></i> Jira</a></li>
                <li><a href="#section-rally"><i class="fas fa-flag-checkered"></i> Rally</a></li>
                <li><a href="#section-app-center"><i class="fas fa-mobile-alt"></i> App Center</a></li>
                <li><a href="#section-chunking"><i class="fas fa-puzzle-piece"></i> Chunking</a></li>
                <li><a href="#section-github"><i class="fab fa-github"></i> GitHub</a></li>
                <li><a href="#section-gitlab"><i class="fab fa-gitlab"></i> GitLab</a></li>
                <li><a href="#section-firebase"><i class="fas fa-fire"></i> Firebase</a></li>
                <li><a href="#section-figma"><i class="fab fa-figma"></i> Figma</a></li>
                <li><a href="#section-retry"><i class="fas fa-redo"></i> Retry Logic</a></li>
                <li><a href="#section-metrics"><i class="fas fa-chart-line"></i> Metrics</a></li>
            </ul>
        </nav>

        <main class="sg-main-content">
            <section class="sg-section">
                <h2>Configuration Settings</h2>
                
                <form id="config-form" class="settings-form">
                    <details id="section-confluence" open>
                        <summary><i class="fas fa-file-alt"></i> Confluence</summary>
                        <div>
                            <label for="CONFLUENCE_BASE_PATH">Base Path</label>
                            <input type="text" id="CONFLUENCE_BASE_PATH" name="CONFLUENCE_BASE_PATH">
                            <div class="hint">Base URL for Confluence API (e.g., https://your-domain.atlassian.net/wiki/rest/api)</div>

                            <label for="CONFLUENCE_LOGIN_PASS_TOKEN">Login/Password or Token</label>
                            <input type="password" id="CONFLUENCE_LOGIN_PASS_TOKEN" name="CONFLUENCE_LOGIN_PASS_TOKEN">
                            <div class="hint">Confluence username:password or API token for authentication.</div>

                            <label for="CONFLUENCE_DEFAULT_SPACE">Default Space</label>
                            <input type="text" id="CONFLUENCE_DEFAULT_SPACE" name="CONFLUENCE_DEFAULT_SPACE">
                            <div class="hint">Default Confluence space key.</div>

                            <label for="CONFLUENCE_GRAPHQL_PATH">GraphQL Path</label>
                            <input type="text" id="CONFLUENCE_GRAPHQL_PATH" name="CONFLUENCE_GRAPHQL_PATH">
                            <div class="hint">Path for Confluence GraphQL API (usually /graphql).</div>
                        </div>
                    </details>

                    <details id="section-openai">
                        <summary><i class="fas fa-brain"></i> OpenAI</summary>
                        <div>
                            <label for="OPEN_AI_BATH_PATH">Base Path</label>
                            <input type="text" id="OPEN_AI_BATH_PATH" name="OPEN_AI_BATH_PATH">
                            <div class="hint">Base URL for OpenAI API (e.g., https://api.openai.com/v1)</div>

                            <label for="OPEN_AI_API_KEY">API Key</label>
                            <input type="password" id="OPEN_AI_API_KEY" name="OPEN_AI_API_KEY">
                            <div class="hint">Your OpenAI API key.</div>

                            <label for="OPEN_AI_MODEL">Default Model</label>
                            <input type="text" id="OPEN_AI_MODEL" name="OPEN_AI_MODEL" placeholder="gpt-4-turbo">
                            <div class="hint">Default OpenAI model to use (e.g., gpt-4-turbo, gpt-3.5-turbo).</div>

                            <label for="CODE_AI_MODEL">Code AI Model</label>
                            <input type="text" id="CODE_AI_MODEL" name="CODE_AI_MODEL" placeholder="gpt-4-turbo">
                            <div class="hint">OpenAI model specifically for code generation tasks.</div>

                            <label for="TEST_AI_MODEL">Test AI Model</label>
                            <input type="text" id="TEST_AI_MODEL" name="TEST_AI_MODEL" placeholder="gpt-4-turbo">
                            <div class="hint">OpenAI model specifically for test generation tasks.</div>
                        </div>
                    </details>

                    <details id="section-gemini">
                        <summary><i class="fas fa-gem"></i> Gemini AI</summary>
                        <div>
                            <label for="GEMINI_BASE_PATH">Base Path</label>
                            <input type="text" id="GEMINI_BASE_PATH" name="GEMINI_BASE_PATH" placeholder="https://generativelanguage.googleapis.com/v1beta/models">
                            <div class="hint">Base URL for Gemini AI API (default: https://generativelanguage.googleapis.com/v1beta/models).</div>

                            <label for="GEMINI_API_KEY">API Key</label>
                            <input type="password" id="GEMINI_API_KEY" name="GEMINI_API_KEY">
                            <div class="hint">Your Gemini AI API key.</div>

                            <label for="GEMINI_DEFAULT_MODEL">Default Model</label>
                            <input type="text" id="GEMINI_DEFAULT_MODEL" name="GEMINI_DEFAULT_MODEL" placeholder="gemini-2.0-flash">
                            <div class="hint">Default Gemini model to use (default: gemini-2.0-flash).</div>
                        </div>
                    </details>

                    <details id="section-jsai">
                        <summary><i class="fas fa-code"></i> JS AI Client</summary>
                        <div>
                            <label for="JSAI_SCRIPT_PATH">Script Path</label>
                            <input type="text" id="JSAI_SCRIPT_PATH" name="JSAI_SCRIPT_PATH">
                            <div class="hint">Path to the JavaScript AI client script file (alternative to inline script below).</div>

                            <label for="JSAI_SCRIPT_CONTENT">JavaScript Code <span style="color: #666;">(or use Script Path above)</span></label>
                            <div style="position: relative; margin-bottom: 15px;">
                                <div id="js-editor-container" style="height: 300px; border: 1px solid var(--border-color, #ddd); border-radius: 4px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 14px; background: var(--card-bg, #fff);"></div>
                                <textarea id="JSAI_SCRIPT_CONTENT" name="JSAI_SCRIPT_CONTENT" style="display: none;"></textarea>
                            </div>
                            <div class="hint">
                                <strong>JavaScript AI Client Template:</strong><br>
                                Your script should export a <code>handleChat</code> function that receives:<br>
                                â€¢ <code>messagesString</code> - JSON string of messages array<br>
                                â€¢ <code>modelToUse</code> - AI model name (e.g., "gpt-4", "gemini-2.0-flash")<br>
                                â€¢ <code>metadataString</code> - JSON string of metadata (temperature, max_tokens, etc.)<br>
                                â€¢ <code>javaClient</code> - Java client instance for HTTP calls and logging<br><br>
                                
                                <strong>Available javaClient methods:</strong><br>
                                â€¢ <code>javaClient.executePost(url, payload, headers)</code><br>
                                â€¢ <code>javaClient.jsLogInfo(message)</code>, <code>javaClient.jsLogWarn(message)</code>, <code>javaClient.jsLogError(message)</code><br><br>
                                
                                <strong>Secret injection:</strong> Use <code>${secrets.API_KEY_NAME!''}</code> for FreeMarker template variables.<br>
                                <a href="javascript:void(0)" onclick="loadJSExample(); return false;" style="color: var(--accent-color); text-decoration: none; font-weight: bold;">
                                    <i class="fas fa-code" style="margin-right: 5px;"></i>ðŸ“‹ Load Gemini Example
                                </a> | 
                                <a href="javascript:void(0)" onclick="loadOpenAIExample(); return false;" style="color: var(--accent-color); text-decoration: none; font-weight: bold; margin-left: 10px;">
                                    <i class="fas fa-brain" style="margin-right: 5px;"></i>ðŸ§  Load OpenAI Example
                                </a>
                            </div>

                            <label for="JSAI_CLIENT_NAME">Client Name</label>
                            <input type="text" id="JSAI_CLIENT_NAME" name="JSAI_CLIENT_NAME" placeholder="JSAIClientFromProperties">
                            <div class="hint">Name identifier for the JS AI client (default: JSAIClientFromProperties).</div>

                            <label for="JSAI_DEFAULT_MODEL">Default Model</label>
                            <input type="text" id="JSAI_DEFAULT_MODEL" name="JSAI_DEFAULT_MODEL">
                            <div class="hint">Default model to use for the JS AI client.</div>

                            <label for="JSAI_BASE_PATH">Base Path</label>
                            <input type="text" id="JSAI_BASE_PATH" name="JSAI_BASE_PATH">
                            <div class="hint">Base URL for the JS AI service.</div>

                            <label for="JSAI_SECRETS_KEYS">Secrets Keys (Comma-separated)</label>
                            <input type="text" id="JSAI_SECRETS_KEYS" name="JSAI_SECRETS_KEYS">
                            <div class="hint">Comma-separated list of secret keys for the JS AI client.</div>
                        </div>
                    </details>

                    <details id="section-bitbucket">
                        <summary><i class="fab fa-bitbucket"></i> Bitbucket</summary>
                        <div>
                            <label for="BITBUCKET_API_VERSION">API Version</label>
                            <input type="text" id="BITBUCKET_API_VERSION" name="BITBUCKET_API_VERSION" placeholder="2.0">
                            <div class="hint">Bitbucket API version (e.g., 2.0).</div>

                            <label for="BITBUCKET_BRANCH">Default Branch</label>
                            <input type="text" id="BITBUCKET_BRANCH" name="BITBUCKET_BRANCH">
                            <div class="hint">Default branch name for Bitbucket repositories.</div>

                            <label for="BITBUCKET_REPOSITORY">Default Repository</label>
                            <input type="text" id="BITBUCKET_REPOSITORY" name="BITBUCKET_REPOSITORY">
                            <div class="hint">Default Bitbucket repository name.</div>

                            <label for="BITBUCKET_WORKSPACE">Workspace</label>
                            <input type="text" id="BITBUCKET_WORKSPACE" name="BITBUCKET_WORKSPACE">
                            <div class="hint">Bitbucket workspace ID or name.</div>

                            <label for="BITBUCKET_TOKEN">Token</label>
                            <input type="password" id="BITBUCKET_TOKEN" name="BITBUCKET_TOKEN">
                            <div class="hint">Bitbucket App Password or Personal Access Token.</div>

                            <label for="BITBUCKET_BASE_PATH">Base Path</label>
                            <input type="text" id="BITBUCKET_BASE_PATH" name="BITBUCKET_BASE_PATH" placeholder="https://api.bitbucket.org">
                            <div class="hint">Base URL for Bitbucket API (e.g., https://api.bitbucket.org).</div>
                        </div>
                    </details>

                    <details id="section-jira">
                        <summary><i class="fab fa-jira"></i> Jira</summary>
                        <div>
                            <label for="JIRA_BASE_PATH">Base Path</label>
                            <input type="text" id="JIRA_BASE_PATH" name="JIRA_BASE_PATH">
                            <div class="hint">Base URL for Jira API (e.g., https://your-domain.atlassian.net/rest/api/2)</div>

                            <label for="JIRA_LOGIN_PASS_TOKEN">Login/Password or Token</label>
                            <input type="password" id="JIRA_LOGIN_PASS_TOKEN" name="JIRA_LOGIN_PASS_TOKEN">
                            <div class="hint">Jira username:password or API token for authentication.</div>

                            <label for="JIRA_AUTH_TYPE">Auth Type</label>
                            <input type="text" id="JIRA_AUTH_TYPE" name="JIRA_AUTH_TYPE" placeholder="Basic or Bearer">
                            <div class="hint">Authentication type for Jira (Basic or Bearer).</div>

                            <label for="SLEEP_TIME_REQUEST">Sleep Time Between Requests (ms)</label>
                            <input type="number" id="SLEEP_TIME_REQUEST" name="SLEEP_TIME_REQUEST" placeholder="100">
                            <div class="hint">Milliseconds to wait between consecutive Jira API requests to avoid rate limiting.</div>

                            <label for="JIRA_EXTRA_FIELDS">Extra Fields (Comma-separated)</label>
                            <input type="text" id="JIRA_EXTRA_FIELDS" name="JIRA_EXTRA_FIELDS">
                            <div class="hint">Comma-separated list of custom Jira field IDs to fetch (e.g., customfield_10001,customfield_10002).</div>

                            <label for="JIRA_EXTRA_FIELDS_PROJECT">Project Key for Extra Fields</label>
                            <input type="text" id="JIRA_EXTRA_FIELDS_PROJECT" name="JIRA_EXTRA_FIELDS_PROJECT">
                            <div class="hint">Specific Jira project key for which the extra fields apply.</div>

                            <label for="JIRA_WAIT_BEFORE_PERFORM">Wait Before Perform</label>
                            <select id="JIRA_WAIT_BEFORE_PERFORM" name="JIRA_WAIT_BEFORE_PERFORM">
                                <option value="">Select...</option>
                                <option value="true">True</option>
                                <option value="false">False</option>
                            </select>
                            <div class="hint">Whether to wait before performing Jira operations.</div>

                            <label for="JIRA_LOGGING_ENABLED">Enable Logging</label>
                            <select id="JIRA_LOGGING_ENABLED" name="JIRA_LOGGING_ENABLED">
                                <option value="">Select...</option>
                                <option value="true">True</option>
                                <option value="false">False</option>
                            </select>
                            <div class="hint">Enable detailed logging for Jira operations.</div>

                            <label for="JIRA_CLEAR_CACHE">Clear Cache</label>
                            <select id="JIRA_CLEAR_CACHE" name="JIRA_CLEAR_CACHE">
                                <option value="">Select...</option>
                                <option value="true">True</option>
                                <option value="false">False</option>
                            </select>
                            <div class="hint">Whether to clear Jira cache on startup.</div>
                        </div>
                    </details>

                    <details id="section-rally">
                        <summary><i class="fas fa-flag-checkered"></i> Rally</summary>
                        <div>
                            <label for="RALLY_TOKEN">Token</label>
                            <input type="password" id="RALLY_TOKEN" name="RALLY_TOKEN">
                            <div class="hint">Rally API token for authentication.</div>

                            <label for="RALLY_PATH">Path</label>
                            <input type="text" id="RALLY_PATH" name="RALLY_PATH">
                            <div class="hint">Rally API path or endpoint.</div>
                        </div>
                    </details>

                    <details id="section-app-center">
                        <summary><i class="fas fa-mobile-alt"></i> App Center</summary>
                        <div>
                            <label for="APP_CENTER_TOKEN">Token</label>
                            <input type="password" id="APP_CENTER_TOKEN" name="APP_CENTER_TOKEN">
                            <div class="hint">Your App Center API token.</div>

                            <label for="APP_CENTER_ORGANIZATION">Organization</label>
                            <input type="text" id="APP_CENTER_ORGANIZATION" name="APP_CENTER_ORGANIZATION">
                            <div class="hint">App Center organization name.</div>
                        </div>
                    </details>

                    <details id="section-chunking">
                        <summary><i class="fas fa-puzzle-piece"></i> Chunk Preparation (AI Prompts)</summary>
                        <div>
                            <label for="PROMPT_CHUNK_TOKEN_LIMIT">Token Limit per Chunk</label>
                            <input type="number" id="PROMPT_CHUNK_TOKEN_LIMIT" name="PROMPT_CHUNK_TOKEN_LIMIT" placeholder="4000">
                            <div class="hint">Maximum number of tokens allowed per AI prompt chunk.</div>

                            <label for="PROMPT_CHUNK_MAX_SINGLE_FILE_SIZE_MB">Max Single File Size (MB)</label>
                            <input type="number" id="PROMPT_CHUNK_MAX_SINGLE_FILE_SIZE_MB" name="PROMPT_CHUNK_MAX_SINGLE_FILE_SIZE_MB" placeholder="4">
                            <div class="hint">Maximum size in MB for a single file to be included in a chunk.</div>

                            <label for="PROMPT_CHUNK_MAX_TOTAL_FILES_SIZE_MB">Max Total Files Size (MB)</label>
                            <input type="number" id="PROMPT_CHUNK_MAX_TOTAL_FILES_SIZE_MB" name="PROMPT_CHUNK_MAX_TOTAL_FILES_SIZE_MB" placeholder="4">
                            <div class="hint">Maximum total size in MB for all files included in a single chunk.</div>

                            <label for="PROMPT_CHUNK_MAX_FILES">Max Files per Chunk</label>
                            <input type="number" id="PROMPT_CHUNK_MAX_FILES" name="PROMPT_CHUNK_MAX_FILES" placeholder="10">
                            <div class="hint">Maximum number of files allowed per AI prompt chunk.</div>
                        </div>
                    </details>

                    <details id="section-github">
                        <summary><i class="fab fa-github"></i> GitHub</summary>
                        <div>
                            <label for="SOURCE_GITHUB_BRANCH">Default Branch</label>
                            <input type="text" id="SOURCE_GITHUB_BRANCH" name="SOURCE_GITHUB_BRANCH">
                            <div class="hint">Default branch name for GitHub repositories.</div>

                            <label for="SOURCE_GITHUB_REPOSITORY">Default Repository</label>
                            <input type="text" id="SOURCE_GITHUB_REPOSITORY" name="SOURCE_GITHUB_REPOSITORY">
                            <div class="hint">Default GitHub repository name (owner/repo).</div>

                            <label for="SOURCE_GITHUB_WORKSPACE">Workspace/Owner</label>
                            <input type="text" id="SOURCE_GITHUB_WORKSPACE" name="SOURCE_GITHUB_WORKSPACE">
                            <div class="hint">GitHub username or organization name.</div>

                            <label for="SOURCE_GITHUB_TOKEN">Token</label>
                            <input type="password" id="SOURCE_GITHUB_TOKEN" name="SOURCE_GITHUB_TOKEN">
                            <div class="hint">GitHub Personal Access Token (PAT).</div>

                            <label for="SOURCE_GITHUB_BASE_PATH">Base Path</label>
                            <input type="text" id="SOURCE_GITHUB_BASE_PATH" name="SOURCE_GITHUB_BASE_PATH" placeholder="https://api.github.com">
                            <div class="hint">Base URL for GitHub API (e.g., https://api.github.com).</div>
                        </div>
                    </details>

                    <details id="section-gitlab">
                        <summary><i class="fab fa-gitlab"></i> GitLab</summary>
                        <div>
                            <label for="GITLAB_BRANCH">Default Branch</label>
                            <input type="text" id="GITLAB_BRANCH" name="GITLAB_BRANCH">
                            <div class="hint">Default branch name for GitLab repositories.</div>

                            <label for="GITLAB_REPOSITORY">Default Repository (Project ID or Path)</label>
                            <input type="text" id="GITLAB_REPOSITORY" name="GITLAB_REPOSITORY">
                            <div class="hint">GitLab project ID or path with namespace (e.g., group/project).</div>

                            <label for="GITLAB_WORKSPACE">Workspace/Group</label>
                            <input type="text" id="GITLAB_WORKSPACE" name="GITLAB_WORKSPACE">
                            <div class="hint">GitLab group or namespace.</div>

                            <label for="GITLAB_TOKEN">Token</label>
                            <input type="password" id="GITLAB_TOKEN" name="GITLAB_TOKEN">
                            <div class="hint">GitLab Personal Access Token.</div>

                            <label for="GITLAB_BASE_PATH">Base Path</label>
                            <input type="text" id="GITLAB_BASE_PATH" name="GITLAB_BASE_PATH" placeholder="https://gitlab.com/api/v4">
                            <div class="hint">Base URL for GitLab API (e.g., https://gitlab.com/api/v4).</div>
                        </div>
                    </details>

                    <details id="section-firebase">
                        <summary><i class="fas fa-fire"></i> Firebase Crashlytics</summary>
                        <div>
                            <label for="FIREBASE_PROJECT_ID">Project ID</label>
                            <input type="text" id="FIREBASE_PROJECT_ID" name="FIREBASE_PROJECT_ID">
                            <div class="hint">Your Firebase project ID.</div>

                            <label for="FIREBASE_SERVICE_ACCOUNT_JSON_AUTH">Service Account JSON</label>
                            <input type="text" id="FIREBASE_SERVICE_ACCOUNT_JSON_AUTH" name="FIREBASE_SERVICE_ACCOUNT_JSON_AUTH">
                            <div class="hint">Path to the Firebase service account JSON key file OR the JSON content itself.</div>
                        </div>
                    </details>

                    <details id="section-figma">
                        <summary><i class="fab fa-figma"></i> Figma</summary>
                        <div>
                            <label for="FIGMA_BASE_PATH">Base Path</label>
                            <input type="text" id="FIGMA_BASE_PATH" name="FIGMA_BASE_PATH" placeholder="https://api.figma.com/v1">
                            <div class="hint">Base URL for Figma API (e.g., https://api.figma.com/v1).</div>

                            <label for="FIGMA_TOKEN">API Key</label>
                            <input type="password" id="FIGMA_TOKEN" name="FIGMA_TOKEN">
                            <div class="hint">Your Figma Personal Access Token.</div>
                        </div>
                    </details>

                    <details id="section-retry">
                        <summary><i class="fas fa-redo"></i> Retry Logic</summary>
                        <div>
                            <label for="AI_RETRY_AMOUNT">AI Retry Amount</label>
                            <input type="number" id="AI_RETRY_AMOUNT" name="AI_RETRY_AMOUNT" placeholder="3">
                            <div class="hint">Number of times to retry a failed AI request.</div>

                            <label for="AI_RETRY_DELAY_STEP">AI Retry Delay Step (ms)</label>
                            <input type="number" id="AI_RETRY_DELAY_STEP" name="AI_RETRY_DELAY_STEP" placeholder="20000">
                            <div class="hint">Initial delay in milliseconds before the first retry, increases incrementally.</div>
                        </div>
                    </details>

                    <details id="section-metrics">
                        <summary><i class="fas fa-chart-line"></i> Metrics</summary>
                        <div>
                            <label for="DEFAULT_TICKET_WEIGHT_IF_NO_SP">Default Ticket Weight (if no Story Points)</label>
                            <input type="number" id="DEFAULT_TICKET_WEIGHT_IF_NO_SP" name="DEFAULT_TICKET_WEIGHT_IF_NO_SP" placeholder="-1">
                            <div class="hint">Default weight to assign to tickets that don't have story points (-1 to ignore).</div>

                            <label for="LINES_OF_CODE_DIVIDER">Lines of Code Divider</label>
                            <input type="number" step="any" id="LINES_OF_CODE_DIVIDER" name="LINES_OF_CODE_DIVIDER" placeholder="1">
                            <div class="hint">Divider for lines of code metrics calculations (default: 1).</div>

                            <label for="TIME_SPENT_ON_DIVIDER">Time Spent Divider</label>
                            <input type="number" step="any" id="TIME_SPENT_ON_DIVIDER" name="TIME_SPENT_ON_DIVIDER" placeholder="1">
                            <div class="hint">Divider for time spent metrics calculations (default: 1).</div>

                            <label for="TICKET_FIELDS_CHANGED_DIVIDER_DEFAULT">Default Field Changed Divider</label>
                            <input type="number" step="any" id="TICKET_FIELDS_CHANGED_DIVIDER_DEFAULT" name="TICKET_FIELDS_CHANGED_DIVIDER_DEFAULT" placeholder="1">
                            <div class="hint">Default divider for ticket field change metrics (default: 1).</div>

                            <label for="IS_READ_PULL_REQUEST_DIFF">Read Pull Request Diff</label>
                            <select id="IS_READ_PULL_REQUEST_DIFF" name="IS_READ_PULL_REQUEST_DIFF">
                                <option value="">Select...</option>
                                <option value="true">True</option>
                                <option value="false">False</option>
                            </select>
                            <div class="hint">Whether to read and analyze pull request diffs (default: true).</div>

                            <label>Ticket Fields Changed Dividers (Dynamic)</label>
                            <div class="hint">Dividers for specific fields in metrics calculations. Loaded dynamically below if present in config. Use format 'TICKET_FIELDS_CHANGED_DIVIDER_FIELDNAME=Value'.</div>
                            <div id="dynamic-metrics-fields">
                                <!-- Dynamic fields will be added here by JavaScript -->
                            </div>
                        </div>
                    </details>

                    <button type="submit" class="settings-submit-btn">
                        <i class="fas fa-save"></i>
                        Save Configuration
                    </button>
                </form>
            </section>
        </main>

        <footer class="sg-footer">
            <p>&copy; 2025 DMTools. All rights reserved.</p>
        </footer>
    </div>

    <script src="css/theme.js"></script>
    <script>
        // Global Monaco Editor instance
        let jsEditor = null;

        // Define example loading functions in global scope
        function loadJSExample() {
            if (jsEditor) {
                const geminiExample = `/**
 * Gemini AI Client - JavaScript Integration Example
 * This script handles chat requests using Google's Gemini AI API
 */

// Main chat handler function - required export
function handleChat(messagesString, modelToUse, metadataString, javaClient) {
    try {
        // Parse input parameters
        const messages = JSON.parse(messagesString);
        const metadata = JSON.parse(metadataString || '{}');
        
        // Log the incoming request
        javaClient.jsLogInfo("Gemini AI: Processing chat request with model: " + modelToUse);
        javaClient.jsLogInfo("Messages count: " + messages.length);
        
        // Build the request payload for Gemini API
        const requestPayload = buildGeminiPayload(messages, metadata, javaClient);
        
        // API endpoint - using secret injection for API key
        const apiKey = '\${secrets.GEMINI_API_KEY!''}';
        const baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models';
        const model = modelToUse || 'gemini-2.0-flash';
        const url = baseUrl + '/' + model + ':generateContent?key=' + apiKey;
        
        // Set up headers
        const headers = {
            'Content-Type': 'application/json',
            'User-Agent': 'DMTools-JSAIClient/1.0'
        };
        
        // Execute the API call
        javaClient.jsLogInfo("Sending request to Gemini API: " + url);
        const response = javaClient.executePost(url, JSON.stringify(requestPayload), headers);
        
        // Parse and return the response
        return processGeminiResponse(response, javaClient);
        
    } catch (error) {
        javaClient.jsLogError("Gemini AI Error: " + error.toString());
        throw new Error("Failed to process Gemini AI request: " + error.message);
    }
}

// Build Gemini-specific request payload
function buildGeminiPayload(messages, metadata, javaClient) {
    const contents = [];
    
    // Convert messages to Gemini format
    for (let i = 0; i < messages.length; i++) {
        const message = messages[i];
        const role = message.role === 'assistant' ? 'model' : 'user';
        
        contents.push({
            role: role,
            parts: [{
                text: message.content
            }]
        });
    }
    
    // Build generation config from metadata
    const generationConfig = {
        temperature: metadata.temperature || 0.7,
        topP: metadata.top_p || 0.95,
        topK: metadata.top_k || 40,
        maxOutputTokens: metadata.max_tokens || 8192,
        candidateCount: 1
    };
    
    // Add safety settings for production use
    const safetySettings = [
        {
            category: "HARM_CATEGORY_HARASSMENT",
            threshold: "BLOCK_MEDIUM_AND_ABOVE"
        },
        {
            category: "HARM_CATEGORY_HATE_SPEECH", 
            threshold: "BLOCK_MEDIUM_AND_ABOVE"
        },
        {
            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
            threshold: "BLOCK_MEDIUM_AND_ABOVE"
        },
        {
            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
            threshold: "BLOCK_MEDIUM_AND_ABOVE"
        }
    ];
    
    const payload = {
        contents: contents,
        generationConfig: generationConfig,
        safetySettings: safetySettings
    };
    
    javaClient.jsLogInfo("Built Gemini payload with " + contents.length + " content parts");
    return payload;
}

// Process Gemini API response
function processGeminiResponse(responseString, javaClient) {
    try {
        const response = JSON.parse(responseString);
        
        // Log response details
        javaClient.jsLogInfo("Received Gemini response");
        
        // Check for errors
        if (response.error) {
            javaClient.jsLogError("Gemini API Error: " + JSON.stringify(response.error));
            throw new Error("Gemini API Error: " + response.error.message);
        }
        
        // Extract the generated content
        if (response.candidates && response.candidates.length > 0) {
            const candidate = response.candidates[0];
            
            // Check finish reason
            if (candidate.finishReason && candidate.finishReason !== 'STOP') {
                javaClient.jsLogWarn("Gemini finished with reason: " + candidate.finishReason);
            }
            
            // Extract content
            if (candidate.content && candidate.content.parts && candidate.content.parts.length > 0) {
                const generatedText = candidate.content.parts[0].text;
                
                // Log success
                javaClient.jsLogInfo("Successfully generated " + generatedText.length + " characters");
                
                // Return in expected format
                return {
                    content: generatedText,
                    model: response.model || 'gemini-2.0-flash',
                    finishReason: candidate.finishReason || 'stop',
                    usage: {
                        promptTokens: response.usageMetadata?.promptTokenCount || 0,
                        completionTokens: response.usageMetadata?.candidatesTokenCount || 0,
                        totalTokens: response.usageMetadata?.totalTokenCount || 0
                    }
                };
            }
        }
        
        // If we get here, no valid content was found
        javaClient.jsLogError("No valid content in Gemini response");
        throw new Error("No valid content received from Gemini API");
        
    } catch (parseError) {
        javaClient.jsLogError("Failed to parse Gemini response: " + parseError.toString());
        throw new Error("Invalid response from Gemini API: " + parseError.message);
    }
}

// Export the main function (this comment helps IDEs understand the export)
// The actual export mechanism depends on your JavaScript runtime environment`;

                jsEditor.setValue(geminiExample);
                console.log("Loaded Gemini AI example code");
                alert("âœ… Gemini example loaded successfully!");
            } else {
                alert("âŒ Editor not ready. Please try again in a moment.");
            }
        }

        function loadOpenAIExample() {
            if (jsEditor) {
                const openaiExample = `/**
 * OpenAI Client - JavaScript Integration Example
 * This script handles chat requests using OpenAI's GPT API
 */

function handleChat(messagesString, modelToUse, metadataString, javaClient) {
    try {
        // Parse input parameters
        const messages = JSON.parse(messagesString);
        const metadata = JSON.parse(metadataString || '{}');
        
        javaClient.jsLogInfo("OpenAI: Processing chat with model: " + modelToUse);
        
        // Build request payload
        const requestPayload = {
            model: modelToUse || 'gpt-4-turbo',
            messages: messages,
            temperature: metadata.temperature || 0.7,
            max_tokens: metadata.max_tokens || 4096,
            top_p: metadata.top_p || 1.0,
            frequency_penalty: metadata.frequency_penalty || 0,
            presence_penalty: metadata.presence_penalty || 0
        };
        
        // API setup with secret injection
        const apiKey = '\${secrets.OPEN_AI_API_KEY!''}';
        const url = 'https://api.openai.com/v1/chat/completions';
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + apiKey,
            'User-Agent': 'DMTools-JSAIClient/1.0'
        };
        
        // Execute API call
        javaClient.jsLogInfo("Sending request to OpenAI API");
        const response = javaClient.executePost(url, JSON.stringify(requestPayload), headers);
        
        // Process response
        const parsedResponse = JSON.parse(response);
        
        if (parsedResponse.error) {
            throw new Error("OpenAI API Error: " + parsedResponse.error.message);
        }
        
        const choice = parsedResponse.choices[0];
        javaClient.jsLogInfo("OpenAI response received successfully");
        
        return {
            content: choice.message.content,
            model: parsedResponse.model,
            finishReason: choice.finish_reason,
            usage: parsedResponse.usage
        };
        
    } catch (error) {
        javaClient.jsLogError("OpenAI Error: " + error.toString());
        throw error;
    }
}`;

                jsEditor.setValue(openaiExample);
                console.log("Loaded OpenAI example code");
                alert("âœ… OpenAI example loaded successfully!");
            } else {
                alert("âŒ Editor not ready. Please try again in a moment.");
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Monaco Editor
            require.config({ paths: { vs: 'https://unpkg.com/monaco-editor@0.45.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                jsEditor = monaco.editor.create(document.getElementById('js-editor-container'), {
                    value: '',
                    language: 'javascript',
                    theme: document.body.classList.contains('dark-theme') ? 'vs-dark' : 'vs',
                    fontSize: 14,
                    minimap: { enabled: false },
                    wordWrap: 'on',
                    automaticLayout: true,
                    scrollBeyondLastLine: false,
                    lineNumbers: 'on',
                    folding: true,
                    tabSize: 2
                });

                // Sync editor content with hidden textarea
                jsEditor.onDidChangeModelContent(function () {
                    document.getElementById('JSAI_SCRIPT_CONTENT').value = jsEditor.getValue();
                });

                // Theme synchronization
                const observer = new MutationObserver(function() {
                    if (jsEditor) {
                        const theme = document.body.classList.contains('dark-theme') ? 'vs-dark' : 'vs';
                        monaco.editor.setTheme(theme);
                    }
                });
                observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
            });

            // Handle section navigation
            const menuLinks = document.querySelectorAll('.settings-navigation a[href^="#"]');
            menuLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    menuLinks.forEach(l => l.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    // Get the section id from href
                    const sectionId = this.getAttribute('href');
                    
                    // Close all details
                    document.querySelectorAll('details').forEach(detail => {
                        detail.removeAttribute('open');
                    });
                    
                    // Open the target details
                    const targetDetail = document.querySelector(sectionId);
                    if (targetDetail) {
                        targetDetail.setAttribute('open', true);
                        
                        // Scroll to the section
                        targetDetail.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            // Theme switcher functionality handled by theme.js
            const switcher = document.getElementById('theme-toggle');
            if (switcher) {
                const sunIcon = switcher.querySelector('.sun-icon');
                const moonIcon = switcher.querySelector('.moon-icon');

                if (sunIcon && moonIcon) {
                    function syncIcons() {
                        if (document.body.classList.contains('dark-theme')) {
                            sunIcon.style.display = 'none';
                            moonIcon.style.display = 'block';
                        } else {
                            sunIcon.style.display = 'block';
                            moonIcon.style.display = 'none';
                        }
                    }
                    syncIcons();
                    switcher.addEventListener('click', function() {
                        setTimeout(syncIcons, 0); 
                    });
                    
                    const observer = new MutationObserver(syncIcons);
                    observer.observe(document.body, { attributes: true, attributeFilter: ['class'] });
                }
            }

            // Fetch configuration data
            fetch('/api/config')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(configData => {
                    console.log('Configuration received:', configData);
                    populateForm(configData);
                })
                .catch(error => {
                    console.error('Error fetching configuration:', error);
                    // Don't show error to user as this might be during local development
                });

            function populateForm(config) {
                const dynamicMetricsContainer = document.getElementById('dynamic-metrics-fields');
                if (dynamicMetricsContainer) {
                    dynamicMetricsContainer.innerHTML = ''; // Clear previous dynamic fields
                }

                for (const key in config) {
                    if (config.hasOwnProperty(key)) {
                        const inputElement = document.getElementById(key);
                        if (inputElement) {
                            // Directly set value for standard inputs
                            inputElement.value = config[key];
                        } else if (key.startsWith('TICKET_FIELDS_CHANGED_DIVIDER_') && dynamicMetricsContainer) {
                            // Dynamically create inputs for metric dividers
                            const fieldName = key.substring('TICKET_FIELDS_CHANGED_DIVIDER_'.length);
                            const label = document.createElement('label');
                            label.htmlFor = key;
                            // Convert FOO_BAR to Foo Bar for display
                            label.textContent = `Divider: ${fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}`;

                            const input = document.createElement('input');
                            input.type = 'number'; // Assuming dividers are numbers
                            input.step = 'any'; // Allow decimals
                            input.id = key;
                            input.name = key;
                            input.value = config[key];
                            input.style.marginBottom = '10px'; // Add some spacing

                            dynamicMetricsContainer.appendChild(label);
                            dynamicMetricsContainer.appendChild(input);
                        }
                    }
                }
            }

            document.getElementById('config-form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Collect form data
                const formData = new FormData(this);
                const formObject = {};
                
                formData.forEach((value, key) => {
                    formObject[key] = value;
                });
                
                // Add dynamic metrics fields
                if (document.querySelectorAll('#dynamic-metrics-fields input')) {
                    document.querySelectorAll('#dynamic-metrics-fields input').forEach(input => {
                        formObject[input.name] = input.value;
                    });
                }
                
                // Would typically send to server
                console.log('Saving configuration:', formObject);
                
                alert('Configuration saved successfully!');
            });
        });
    </script>
    <script>
        function stopServer() {
            fetch('/shutdown', { method: 'POST' })
                .then(response => response.text())
                .then(data => {
                    document.body.innerHTML = `<div style="text-align: center; padding-top: 50px;"><h1>${data}</h1><p>You can close this window.</p></div>`;
                    setTimeout(() => window.close(), 2000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error stopping server. See console for details.');
                });
        }
    
        document.addEventListener("DOMContentLoaded", function() {
            fetch('/is-local')
                .then(response => response.json())
                .then(isLocal => {
                    if (isLocal) {
                        document.getElementById("stop-server-container").style.display = "block";
                    }
            });
        });
    </script>
</body>
</html> 