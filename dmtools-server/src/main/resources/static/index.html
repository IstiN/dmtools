<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMTools - Delivery Manager Tools</title>
    <link rel="icon" href="img/dmtools-icon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styleguide/styleguide.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="components/chat-component.css">
    <script src="js/auth.js"></script>
    <script src="js/workspace-manager.js"></script>
</head>
<body>
<!-- Site header -->
<header class="site-header">
    <a href="/" class="site-title">
        <img src="img/dmtools-logo-network-nodes.svg" alt="DMTools Logo" class="logo-light" style="height: 48px;" />
        <img src="img/dmtools-logo-network-nodes-dark.svg" alt="DMTools Logo" class="logo-dark" style="height: 48px; display: none;" />
    </a>
    
    <!-- Search form using styleguide component -->
    <form class="search-form">
        <input type="search" placeholder="Search agents and apps..." aria-label="Search">
        <button type="submit" class="btn">Search</button>
    </form>
    
    <div class="nav-actions">
        <button class="btn btn-icon" id="theme-toggle" title="Toggle theme">
            <i class="fas fa-moon" id="theme-icon"></i>
        </button>
        <button id="chat-toggle-btn" class="btn btn-icon" title="Open AI Assistant">
            <i class="fas fa-comments"></i>
        </button>
        <button class="btn btn-login" onclick="handleLoginClick()">
            <i class="fas fa-sign-in-alt"></i>
            Login
        </button>
    </div>
</header>

<!-- Landing Page Layout (shown when not authenticated) -->
<div id="landing-page" class="landing-page-layout">
    <div class="container">
        <!-- Welcome banner -->
        <div class="welcome-banner">
            <div class="welcome-logo">
                <img src="img/dmtools-logo-intelligent-network-fusion-white.svg" alt="DMTools Intelligent Network" style="height: 60px; margin-bottom: 20px;">
            </div>
            <div class="welcome-text">
                <h1>Welcome to DMTools</h1>
                <p>Your all-in-one solution for delivery management and automation</p>
                <div class="banner-buttons">
                    <button class="btn btn-primary" onclick="handleLoginClick()">
                        <i class="fas fa-sign-in-alt"></i>
                        Get Started
                    </button>
                    <button id="get-help-btn" class="btn btn-outline" onclick="openChatHelp()">
                        <i class="fas fa-question-circle"></i>
                        Get Help
                    </button>
                </div>
            </div>
        </div>

        <!-- Feature Cards for Landing Page -->
        <div class="features-section">
            <h2 class="section-title">What DMTools Can Do For You</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h3>AI-Powered Agents</h3>
                    <p>Automate repetitive tasks with intelligent agents that learn from your workflow</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-briefcase"></i>
                    </div>
                    <h3>Workspace Management</h3>
                    <p>Organize your projects and teams in dedicated workspaces</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">
                        <i class="fas fa-th-large"></i>
                    </div>
                    <h3>Integrated Applications</h3>
                    <p>Access a suite of tools designed for delivery managers</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- App Layout with Sidebar (shown when authenticated) -->
<div id="app-layout" class="app-layout" style="display: none;">
    <!-- Sidebar Navigation -->
    <nav class="sidebar-nav app-layout__sidebar">
        <div class="sidebar-nav__content">
            <!-- Main Navigation -->
            <div class="sidebar-nav__section">
                <ul class="sidebar-nav__list">
                    <li class="sidebar-nav__item">
                        <a href="/" class="sidebar-nav__link active">
                            <i class="sidebar-nav__icon fas fa-home"></i>
                            <span class="sidebar-nav__text">For You</span>
                        </a>
                    </li>
                    <li class="sidebar-nav__item">
                        <a href="/workspaces.html" class="sidebar-nav__link" id="workspaces-link">
                            <i class="sidebar-nav__icon fas fa-briefcase"></i>
                            <span class="sidebar-nav__text">Workspaces</span>
                        </a>
                    </li>
                    <li class="sidebar-nav__item">
                        <a href="/agents.html" class="sidebar-nav__link">
                            <i class="sidebar-nav__icon fas fa-robot"></i>
                            <span class="sidebar-nav__text">Agents</span>
                            <span class="sidebar-nav__badge">3</span>
                        </a>
                    </li>
                    <li class="sidebar-nav__item">
                        <a href="/applications.html" class="sidebar-nav__link">
                            <i class="sidebar-nav__icon fas fa-th-large"></i>
                            <span class="sidebar-nav__text">Applications</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="app-layout__main">
        <div class="container">
            <!-- Two Column Layout for Agents and Chat -->
            <div class="main-layout">
                <div class="main-content">
                    <!-- Quick Actions -->
                    <div id="quick-actions" class="quick-actions" style="margin: 2rem 0; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <a href="/workspaces.html" class="btn btn-secondary">
                            <i class="fas fa-briefcase"></i>
                            My Workspaces
                        </a>
                        <a href="/settings.html" class="btn btn-secondary">
                            <i class="fas fa-cog"></i>
                            Settings
                        </a>
                    </div>

                    <!-- Agents section -->
                    <div class="section-header">
                        <h2 class="section-title">My Agents</h2>
                        <a href="/agents.html" class="view-all">
                            Manage Agents <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>

                    <div class="agents-grid">
                        <!-- Agent 1 -->
                        <div class="agent-card">
                            <div class="agent-card-header">
                                <div class="agent-card-icon">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div>
                                    <h3 class="agent-card-title">JIRA Assistant</h3>
                                    <div class="agent-card-status">
                                        <span class="status-dot"></span>
                                        Active
                                    </div>
                                </div>
                            </div>
                            <p class="agent-card-description">
                                Automatically analyzes and creates test cases based on JIRA tasks, integrating information from code repositories.
                            </p>
                            <div class="tag-container">
                                <span class="tag">Integration</span>
                            </div>
                            <div class="agent-card-footer">
                                <div class="agent-stats">
                                    <span><i class="fas fa-calendar-check"></i> 12 runs</span>
                                    <span><i class="fas fa-clock"></i> Today</span>
                                </div>
                                <button class="run-button">
                                    <i class="fas fa-play"></i> Run
                                </button>
                            </div>
                        </div>

                        <!-- Agent 2 -->
                        <div class="agent-card">
                            <div class="agent-card-header">
                                <div class="agent-card-icon">
                                    <i class="fas fa-code-branch"></i>
                                </div>
                                <div>
                                    <h3 class="agent-card-title">GitLab Analyzer</h3>
                                    <div class="agent-card-status">
                                        <span class="status-dot"></span>
                                        Active
                                    </div>
                                </div>
                            </div>
                            <p class="agent-card-description">
                                Scans code repositories, identifies critical changes, and generates progress reports.
                            </p>
                            <div class="tag-container">
                                <span class="tag">Analytics</span>
                            </div>
                            <div class="agent-card-footer">
                                <div class="agent-stats">
                                    <span><i class="fas fa-calendar-check"></i> 8 runs</span>
                                    <span><i class="fas fa-clock"></i> Yesterday</span>
                                </div>
                                <button class="run-button">
                                    <i class="fas fa-play"></i> Run
                                </button>
                            </div>
                        </div>

                        <!-- Agent 3 -->
                        <div class="agent-card">
                            <div class="agent-card-header">
                                <div class="agent-card-icon">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div>
                                    <h3 class="agent-card-title">Story Generator</h3>
                                    <div class="agent-card-status">
                                        <span class="status-dot"></span>
                                        Active
                                    </div>
                                </div>
                            </div>
                            <p class="agent-card-description">
                                Creates user stories and requirements based on project documentation and existing tickets.
                            </p>
                            <div class="tag-container">
                                <span class="tag">Automation</span>
                            </div>
                            <div class="agent-card-footer">
                                <div class="agent-stats">
                                    <span><i class="fas fa-calendar-check"></i> 5 runs</span>
                                    <span><i class="fas fa-clock"></i> This week</span>
                                </div>
                                <button class="run-button">
                                    <i class="fas fa-play"></i> Run
                                </button>
                            </div>
                        </div>

                        <!-- Add new agent -->
                        <a href="/create-agent" class="empty-state">
                            <i class="fas fa-plus-circle"></i>
                            <h3>Create New Agent</h3>
                            <p>Configure automation for your tasks</p>
                        </a>
                    </div>

                    <!-- Applications section -->
                    <div class="section-header">
                        <h2 class="section-title">Applications</h2>
                        <a href="/applications.html" class="view-all">
                            All Applications <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>

                    <div class="app-list">
                        <!-- App 1 -->
                        <div class="app-item">
                            <div class="app-icon"><i class="fas fa-chart-pie"></i></div>
                            <div class="app-details">
                                <h3 class="app-title">Presentation Creator</h3>
                                <div class="app-version">v2.1.0</div>
                                <p class="app-description">
                                    Automatically generates presentations based on project data, including progress, charts, and metrics.
                                </p>
                                <span class="app-tag">Reporting</span>
                                <div class="app-stats">
                                    <span><i class="fas fa-star"></i> 4.9</span>
                                    <span><i class="fas fa-download"></i> 1.2k</span>
                                </div>
                            </div>
                            <a href="presentation-creator.html" class="btn btn-primary btn-small">
                                Open
                            </a>
                        </div>

                        <!-- App 2 -->
                        <div class="app-item">
                            <div class="app-icon"><i class="fas fa-envelope"></i></div>
                            <div class="app-details">
                                <h3 class="app-title">Report Generator</h3>
                                <div class="app-version">v1.5.3</div>
                                <p class="app-description">
                                    Creates professional reports and newsletters based on data from JIRA, Confluence, and code repositories.
                                </p>
                                <span class="app-tag">Communication</span>
                                <div class="app-stats">
                                    <span><i class="fas fa-star"></i> 4.7</span>
                                    <span><i class="fas fa-download"></i> 950</span>
                                </div>
                            </div>
                            <a href="#" class="btn btn-primary btn-small">
                                Open
                            </a>
                        </div>

                        <!-- App 3 -->
                        <div class="app-item">
                            <div class="app-icon"><i class="fas fa-bug"></i></div>
                            <div class="app-details">
                                <h3 class="app-title">Bug Analyzer</h3>
                                <div class="app-version">v1.2.0</div>
                                <p class="app-description">
                                    Analyzes error reports, classifies issues, and suggests solutions based on historical data.
                                </p>
                                <span class="app-tag">QA</span>
                                <div class="app-stats">
                                    <span><i class="fas fa-star"></i> 4.5</span>
                                    <span><i class="fas fa-download"></i> 720</span>
                                </div>
                            </div>
                            <a href="#" class="btn btn-primary btn-small">
                                Open
                            </a>
                        </div>

                        <!-- App 4 -->
                        <div class="app-item">
                            <div class="app-icon"><i class="fas fa-tasks"></i></div>
                            <div class="app-details">
                                <h3 class="app-title">Sprint Planner</h3>
                                <div class="app-version">v2.3.1</div>
                                <p class="app-description">
                                    Optimizes sprint planning considering team capacity, priorities, and task dependencies.
                                </p>
                                <span class="app-tag">Planning</span>
                                <div class="app-stats">
                                    <span><i class="fas fa-star"></i> 4.8</span>
                                    <span><i class="fas fa-download"></i> 1.5k</span>
                                </div>
                            </div>
                            <a href="#" class="btn btn-primary btn-small">
                                Open
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Chat Sidebar (optional, can be toggled) -->
                <div class="chat-sidebar" id="chat-sidebar" style="display: none;">
                    <div class="chat-sidebar-header">
                        <h3><i class="fas fa-comments"></i> AI Assistant</h3>
                        <button class="btn-icon" onclick="toggleChatSidebar()" title="Close chat">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="sidebar-chat-container" class="chat-container-embedded"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Floating Chat Container (for floating mode) -->
<div id="dm-chat-floating" style="display: none;"></div>

<script src="js/app.js"></script>
<script src="css/theme.js"></script>
<script src="components/chat-component.js"></script>
<script>
    // Global chat instances
    let floatingChat = null;
    let sidebarChat = null;

    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded and parsed. Checking for auth status and errors.");
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const loginStatus = urlParams.get('login');
        const error = urlParams.get('error');
        
        if (error === 'true') {
            console.error("Login error detected. Clearing session and auth states.");
            // Clear all cookies
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            localStorage.removeItem('authToken');
            
            showLoginButton();
            showNotification('Login failed. Please try again.', 'error');
        } else if (loginStatus === 'success' && token) {
            console.log('Login successful, storing token.');
            localStorage.setItem('authToken', token);
            showNotification('Login successful!', 'success');
        }
        
        // Clear URL parameters after processing
        if (window.history.replaceState) {
            const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({ path: cleanUrl }, '', cleanUrl);
        }
        
        initializeFloatingChat();
        initializeChatToggle();
        checkAuth();
        
        // Subscribe to auth state changes
        if (window.authManager) {
            window.authManager.onAuthChange((isAuthenticated, user) => {
                console.log('Auth state changed:', isAuthenticated, user);
                checkAuth();
            });
        }
    });

    function openLoginModal() {
        if (window.authManager && window.authManager.showLoginModal) {
            window.authManager.showLoginModal();
        } else {
            console.error('AuthManager not available');
        }
    }

    function closeLoginModal() {
        if (window.authManager && window.authManager.hideLoginModal) {
            window.authManager.hideLoginModal();
        }
    }

    function initializeChatToggle() {
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        if (chatToggleBtn) {
            chatToggleBtn.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    // On mobile, use floating chat
                    toggleFloatingChat();
                } else {
                    // On desktop, use sidebar
                    toggleChatSidebar();
                }
            });
        }

        // Responsive handling
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                // Hide sidebar on mobile
                const sidebar = document.getElementById('chat-sidebar');
                if (sidebar && sidebar.style.display !== 'none') {
                    toggleChatSidebar();
                }
            } else {
                // Hide floating chat on desktop
                if (floatingChat && document.getElementById('dm-chat-floating').style.display !== 'none') {
                    toggleFloatingChat();
                }
            }
        });
    }

    function initializeFloatingChat() {
        floatingChat = DMChatComponent.createFloating({
            title: 'DMTools AI',
            context: 'general',
            welcomeMessage: 'Hi! I can help you with agents, applications, and general questions about DMTools. I have access to JIRA, GitHub, Confluence, and AI agents!',
            placeholder: 'Ask me about DMTools...',
            enableFileAttachments: true,
            agentTools: {'enabled': true},
            examples: [
                'Show me available agents and tools',
                'How do I integrate with JIRA?',
                'Help me automate my workflow',
                'What can DMTools do for my team?',
                'Guide me through the features',
                'Search JIRA tickets for my project',
                'Get GitHub repository information',
                'Create a Confluence page',
                'Generate test cases for my application'
            ],
            emptyStateConfig: {
                title: 'DMTools AI Assistant',
                message: 'I\'m here to help you navigate DMTools and make the most of its powerful features.',
                subtitle: 'Ask me about agents, integrations, workflows, or any questions about the platform. I can access real-time data from JIRA, GitHub, and Confluence!'
            },
            callbacks: {
                onHealthCheck: (isHealthy) => {
                    if (!isHealthy) {
                        console.warn('Chat service is not available');
                    }
                }
            },
            // Enable MCP tools integration
            enableMcpTools: true
        });
        
        // Initially hidden
        document.getElementById('dm-chat-floating').style.display = 'none';
    }

    function toggleFloatingChat() {
        const chatContainer = document.getElementById('dm-chat-floating');
        if (chatContainer.style.display === 'none') {
            chatContainer.style.display = 'block';
            floatingChat.show();
        } else {
            chatContainer.style.display = 'none';
            floatingChat.close();
        }
    }

    function toggleChatSidebar() {
        const sidebar = document.getElementById('chat-sidebar');
        const container = document.querySelector('.container');
        
        if (sidebar.style.display === 'none') {
            // Show sidebar
            sidebar.style.display = 'block';
            container.classList.add('with-chat-sidebar');
            
            // Initialize sidebar chat if not exists
            if (!sidebarChat) {
                sidebarChat = DMChatComponent.createEmbedded('sidebar-chat-container', {
                    title: 'DMTools AI',
                    context: 'general',
                    welcomeMessage: 'Hi! I can help you with agents, applications, and general questions about DMTools. I have access to JIRA, GitHub, Confluence, and AI agents!',
                    placeholder: 'Ask me about DMTools...',
                    height: '500px',
                    enableFileAttachments: true,
                    agentTools: {'enabled': true},
                    theme: 'compact',
                    examples: [
                        'Show me available agents and tools',
                        'How do I integrate with JIRA?',
                        'Help me automate my workflow',
                        'What can DMTools do for my team?',
                        'Guide me through the features',
                        'Search JIRA tickets for my project',
                        'Get GitHub repository information',
                        'Create a Confluence page',
                        'Generate test cases for my application'
                    ],
                    emptyStateConfig: {
                        title: 'DMTools AI Assistant',
                        message: 'I\'m here to help you navigate DMTools and make the most of its powerful features.',
                        subtitle: 'Ask me about agents, integrations, workflows, or any questions about the platform. I can access real-time data from JIRA, GitHub, and Confluence!'
                    },
                    // Enable MCP tools integration
                    enableMcpTools: true
                });
            }
        } else {
            // Hide sidebar
            sidebar.style.display = 'none';
            container.classList.remove('with-chat-sidebar');
        }
    }

    function openChatHelp() {
        if (window.innerWidth <= 768) {
            toggleFloatingChat();
            // Add a helpful message
            setTimeout(() => {
                if (floatingChat) {
                    floatingChat.useExample('Help me get started with DMTools');
                }
            }, 500);
        } else {
            toggleChatSidebar();
            // Add a helpful message
            setTimeout(() => {
                if (sidebarChat) {
                    sidebarChat.useExample('Help me get started with DMTools');
                }
            }, 500);
        }
    }

    // Delegate to AuthManager's demo login
    window.loginWithTestUser = function() {
        if (window.authManager && window.authManager.loginAsDemo) {
            window.authManager.loginAsDemo();
        } else {
            console.error('AuthManager not available for demo login');
        }
    }

    async function handleModalLogin(provider) {
        event.preventDefault();
        
        // Add loading state
        const button = event.currentTarget;
        button.classList.add('login-provider-btn--loading');
        
        try {
            // Use Spring Security OAuth2 login endpoints
            const oauthUrl = `/oauth2/authorization/${provider.toLowerCase()}`;
            
            // Close the modal first
            closeLoginModal();
            
            // Redirect to Spring Security OAuth2 login
            window.location.href = oauthUrl;
            
        } catch (error) {
            console.error('Login error:', error);
            button.classList.remove('login-provider-btn--loading');
            showNotification(`Login failed: ${error.message}`, 'error');
        }
    }

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('loginModal');
        if (event.target === modal) {
            closeLoginModal();
        }
    });

    // Close modal with Escape key
    window.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeLoginModal();
        }
    });

    // Update UI for logged-in user
    async function updateUIForLoggedInUser() {
        console.log("updateUIForLoggedInUser: Checking authentication status...");
        try {
            // Check authentication status via Spring Security session
            const response = await fetch('/api/auth/user', {
                credentials: 'include', // Include session cookies
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // Mark as AJAX request
                }
            });

            console.log(`updateUIForLoggedInUser: Received response with status ${response.status}`);

            if (response.ok) {
                const user = await response.json();
                console.log('updateUIForLoggedInUser: User data received:', user);
                
                if (user.authenticated === true) {
                    console.log("updateUIForLoggedInUser: User is authenticated. Updating UI.");
                    // Show app layout and hide landing page
                    document.getElementById('landing-page').style.display = 'none';
                    document.getElementById('app-layout').style.display = 'flex';
                    updateLoginButton(user);
                } else {
                    console.log('updateUIForLoggedInUser: User not authenticated. Showing login button.');
                    // Show landing page and hide app layout
                    document.getElementById('landing-page').style.display = 'block';
                    document.getElementById('app-layout').style.display = 'none';
                    showLoginButton();
                }
            } else if (response.status === 401) {
                // Not authenticated - this is expected for non-logged in users
                console.log('updateUIForLoggedInUser: User not authenticated (401). Showing login button.');
                // Show landing page and hide app layout
                document.getElementById('landing-page').style.display = 'block';
                document.getElementById('app-layout').style.display = 'none';
                showLoginButton();
            } else {
                // Other error
                console.error('updateUIForLoggedInUser: Error checking auth status:', response.status, await response.text());
                // Show landing page and hide app layout
                document.getElementById('landing-page').style.display = 'block';
                document.getElementById('app-layout').style.display = 'none';
                showLoginButton();
            }
        } catch (error) {
            console.error('updateUIForLoggedInUser: Error fetching user info:', error);
            // Show landing page and hide app layout
            document.getElementById('landing-page').style.display = 'block';
            document.getElementById('app-layout').style.display = 'none';
            showLoginButton();
        }
    }

    function showLoginButton() {
        console.log("showLoginButton: Displaying the main login button.");
        const loginButton = document.querySelector('.btn-login');
        if (loginButton) {
            loginButton.innerHTML = `
                <i class="fas fa-sign-in-alt"></i>
                Login
            `;
            // Don't set onclick here - auth.js handles it
        }
    }

    function showQuickActions() {
        const quickActions = document.getElementById('quick-actions');
        if (quickActions) quickActions.style.display = 'flex';
    }

    function getInitials(name) {
        if (!name) return '';
        return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    }

    function updateLoginButton(user) {
        console.log("updateLoginButton: Updating UI for logged-in user:", user.name);
        const loginButton = document.querySelector('.btn-login');
        if (loginButton) {
            // Remove any existing onclick handler from auth.js
            loginButton.removeAttribute('onclick');
            
            // Get display name - prefer givenName, fallback to name, then email
            let displayName = user.name || user.email || 'User';
            if (user.givenName && user.familyName) {
                displayName = `${user.givenName} ${user.familyName}`;
            } else if (user.givenName) {
                displayName = user.givenName;
            }
            
            // Get profile image or use fallback icon
            let profileImage;
            if (user.pictureUrl && user.pictureUrl.trim() !== '') {
                profileImage = `<img src="${user.pictureUrl}" alt="Profile" class="user-avatar" onerror="this.outerHTML='<div class=\\'user-avatar user-avatar--fallback\\' data-initials=\\'${getInitials(displayName)}\\'><i class=\\'fas fa-user\\'></i></div>';">`;
            } else {
                profileImage = `<div class="user-avatar user-avatar--fallback" data-initials="${getInitials(displayName)}">
                                   <i class="fas fa-user"></i>
                               </div>`;
            }
            
            loginButton.innerHTML = `
                <div class="user-profile-button">
                    ${profileImage}
                    <span class="user-name">${displayName}</span>
                    <i class="fas fa-chevron-down user-chevron"></i>
                </div>
            `;
            
            // Use a proper click handler instead of onclick
            loginButton.addEventListener('click', showUserMenu, { once: true });
        }
    }

    function showUserMenu(event) {
        event.stopPropagation();
        console.log("showUserMenu: Toggling user menu.");
        // Create and show user menu dropdown
        const existingMenu = document.querySelector('.user-menu');
        if (existingMenu) {
            console.log("showUserMenu: User menu already exists. Removing existing menu.");
            existingMenu.remove();
            return;
        }

        console.log("showUserMenu: Creating new user menu.");
        const menu = document.createElement('div');
        menu.className = 'user-menu';
        menu.innerHTML = `
            <div class="user-menu-item" onclick="openUserSettings()">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="user-menu-item" id="user-menu-theme-switcher">
                <i class="fas fa-moon"></i>
                <span>Dark mode</span>
            </div>
            <div class="user-menu-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Logout</span>
            </div>
        `;

        const loginButton = document.querySelector('.btn-login');
        loginButton.parentNode.appendChild(menu);

        // Update theme switcher icon based on current theme
        const isDark = document.body.classList.contains('dark-theme');
        const themeIcon = menu.querySelector('#user-menu-theme-switcher i');
        themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        const themeText = menu.querySelector('#user-menu-theme-switcher span');
        themeText.textContent = isDark ? 'Light mode' : 'Dark mode';

        // Add event listener for theme switcher
        menu.querySelector('#user-menu-theme-switcher').addEventListener('click', () => {
            const isDark = document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Update theme icon in menu
            themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            themeText.textContent = isDark ? 'Light mode' : 'Dark mode';
            // Update main theme toggle button
            const mainThemeIcon = document.getElementById('theme-icon');
            if (mainThemeIcon) {
                mainThemeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            }
        });

        // Position the menu
        const rect = loginButton.getBoundingClientRect();
        menu.style.top = `${rect.bottom + 5}px`;
        menu.style.right = `${window.innerWidth - rect.right}px`;

        // Re-add click handler for next time
        loginButton.addEventListener('click', showUserMenu, { once: true });

        // Close menu when clicking outside
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(event) {
                if (!loginButton.contains(event.target) && !menu.contains(event.target)) {
                    console.log("showUserMenu: Closing user menu due to outside click.");
                    menu.remove();
                    // Re-add click handler when menu is closed
                    loginButton.addEventListener('click', showUserMenu, { once: true });
                }
            }, { once: true });
        }, 0);
    }

    function openUserSettings() {
        window.location.href = '/settings.html';
    }

    async function logout() {
        console.log("logout: Initiating logout sequence.");
        try {
            // Clear any stored tokens
            localStorage.removeItem('authToken');
            
            // Clear all cookies by setting them to expire
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            // Use Spring Security logout with CSRF token
            const response = await fetch('/logout', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            });

            console.log(`logout: Received response with status ${response.status}`);
            
            // Update UI immediately regardless of response
            showLoginButton();
            
            // Close any open user menu
            const userMenu = document.querySelector('.user-menu');
            if (userMenu) {
                userMenu.remove();
            }
            
            // Force a page reload to ensure all session data is cleared
            // Only reload if not in test environment
            if (!window.location.href.includes('playwright')) {
                setTimeout(() => {
                    console.log("logout: Reloading page to ensure clean state.");
                    window.location.reload();
                }, 1000);
            }
            
            if (response.ok) {
                console.log("logout: Logout successful.");
                showNotification('Logged out successfully.', 'success');
            } else {
                console.error('Logout failed:', response.status);
                showNotification('Logout failed. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Error during logout:', error);
            // Still update UI even if logout request failed
            showLoginButton();
            // Force reload even on error to ensure clean state
            // Only reload if not in test environment
            if (!window.location.href.includes('playwright')) {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
            showNotification('An error occurred during logout.', 'error');
        }
    }

    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            ${message}
        `;

        document.body.appendChild(notification);

        // Show notification
        setTimeout(() => notification.classList.add('show'), 100);

        // Hide notification after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Close user menu when clicking outside
    document.addEventListener('click', function(event) {
        const userMenu = document.querySelector('.user-menu');
        const loginButton = document.querySelector('.btn-login');
        
        if (userMenu && !userMenu.contains(event.target) && !loginButton.contains(event.target)) {
            userMenu.remove();
        }
    });

    async function checkAuth() {
        try {
            await updateUIForLoggedInUser();
        } catch (error) {
            console.error('Error checking authentication:', error);
            showLoginButton();
        }
    }

    // Make openChatHelp available globally
    window.openChatHelp = openChatHelp;
</script>

<style>
/* Additional styles for chat integration */
.main-layout {
    display: flex;
    gap: 2rem;
    transition: all 0.3s ease;
}

.main-content {
    flex: 1;
    min-width: 0; /* Prevent overflow */
}

.chat-sidebar {
    width: 400px;
    flex-shrink: 0;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    height: fit-content;
    max-height: 80vh;
    position: sticky;
    top: 2rem;
    box-shadow: var(--card-shadow);
}

.chat-sidebar-header {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--hover-bg);
    border-radius: 12px 12px 0 0;
}

.chat-sidebar-header h3 {
    margin: 0;
    color: var(--header-color);
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chat-container-embedded {
    height: 500px;
    border-radius: 0 0 12px 12px;
    overflow: hidden;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .chat-sidebar {
        width: 350px;
    }
}

@media (max-width: 768px) {
    .main-layout {
        flex-direction: column;
    }
    
    .chat-sidebar {
        display: none !important; /* Force hide on mobile */
    }

    .nav-actions {
        gap: 0.5rem;
    }
    
    .nav-actions .theme-text {
        display: none; /* Hide theme text on mobile to save space */
    }

    .btn-login {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }

    .btn-login i {
        font-size: 0.8rem;
    }
}

/* Layout adjustment when sidebar is open */
.container.with-chat-sidebar .main-layout {
    max-width: none;
    margin: 0 auto;
}

/* Animate the banner buttons */
.banner-buttons {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    justify-content: center;
}

@media (max-width: 768px) {
    .banner-buttons {
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
    }
    
    .banner-buttons .btn {
        width: 200px;
        justify-content: center;
    }
}

/* User menu styles */
.user-menu {
    position: absolute;
    z-index: 1000;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: var(--card-shadow);
    padding: 0.5rem;
    min-width: 200px;
    animation: fadeIn 0.1s ease-out;
}

.user-menu-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.8rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    color: var(--text-color);
}

.user-menu-item:hover {
    background-color: var(--hover-bg);
}

.user-menu-item i {
    width: 16px;
    text-align: center;
    color: var(--text-secondary);
}

.user-menu-item span {
    flex-grow: 1;
}

/* Notification styles */
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 9999;
    max-width: 350px;
}

.notification.show {
    transform: translateX(0);
    opacity: 1;
}

.notification-success {
    border-left: 4px solid #22c55e;
}

.notification-success i {
    color: #22c55e;
}

.notification-error {
    border-left: 4px solid #ef4444;
}

.notification-error i {
    color: #ef4444;
}

/* User profile button styles */
.btn-login {
    display: flex;
    align-items: center;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.user-profile-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    width: 100%;
}

.user-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.user-avatar--fallback {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-size: 0.75rem;
    font-weight: 400;
    position: relative;
}

.user-avatar--fallback i {
    line-height: 1;
    margin: 0;
    padding: 0;
}

/* Show initials if icon is not available */
.user-avatar--fallback:not(:has(i.fas)):before,
.user-avatar--fallback i.fas:not(.fa-user):after {
    content: attr(data-initials);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    font-weight: 500;
    font-size: 0.7rem;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
}

/* Hide initials when icon is properly loaded */
.user-avatar--fallback:has(i.fas.fa-user) {
    font-size: 0.75rem;
}

/* Fallback for browsers that don't support :has() */
@supports not (selector(:has(*))) {
    .user-avatar--fallback::after {
        content: attr(data-initials);
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        font-weight: 500;
        font-size: 0.7rem;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    
    .user-avatar--fallback i {
        display: none;
    }
}

.user-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-weight: 500;
}

.user-chevron {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-left: 0.25rem;
    flex-shrink: 0;
}

/* Hover effects for user profile */
.btn-login:hover {
    background-color: var(--hover-bg);
}

.btn-login:hover .user-chevron {
    opacity: 1;
    transform: translateY(1px);
}

.login-provider-btn--microsoft {
    background-color: #0078D4;
    color: white;
}

.login-provider-btn--github {
    background-color: #333;
    color: white;
}

.login-provider-btn:hover {
    opacity: 0.9;
}

.logo-dark { display: none; }
body.dark-theme .logo-light { display: none !important; }
body.dark-theme .logo-dark { display: inline !important; }

/* Landing Page Styles */
.landing-page-layout {
    min-height: calc(100vh - 60px); /* Account for header */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 0;
}

.features-section {
    margin-top: 4rem;
    text-align: center;
}

.features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.feature-card {
    background: var(--card-bg);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    text-align: center;
}

.feature-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--card-hover-shadow);
}

.feature-icon {
    width: 60px;
    height: 60px;
    margin: 0 auto 1rem;
    background: var(--accent-color);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
}

.feature-card h3 {
    color: var(--text-color);
    margin-bottom: 0.5rem;
}

.feature-card p {
    color: var(--text-secondary);
    line-height: 1.6;
}

/* Hide sidebar on index page when not authenticated */
#landing-page ~ .app-layout {
    display: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .landing-page-layout {
        padding: 1rem;
    }
    
    .features-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .feature-card {
        padding: 1.5rem;
    }
}
</style>
</body>
</html> 