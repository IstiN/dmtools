<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workspaces - DMTools</title>
    <link rel="stylesheet" href="styleguide/styleguide.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="img/favicon.ico">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="app-header__main">
                <div class="app-header__icon">
                    <img src="img/dmtools-logo-intelligent-network-fusion-white.svg" alt="DMTools" width="32" height="32">
                </div>
                <div class="app-header__info">
                    <h1>Workspaces</h1>
                    <p>Manage and organize your development workspaces</p>
                </div>
                <div class="app-header__actions">
                    <button class="btn btn-icon theme-switch" id="theme-toggle" title="Toggle theme">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </button>
                    <div class="user-profile-button" id="user-profile">
                        <div class="user-avatar user-avatar--fallback" data-initials="U">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="user-name" id="user-name">Loading...</span>
                        <i class="fas fa-chevron-down user-chevron"></i>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Loading State -->
            <div id="loading-state" class="workspace-empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <h3>Loading workspaces...</h3>
                <p>Please wait while we fetch your workspaces.</p>
            </div>

            <!-- Create Workspace Section -->
            <div id="create-workspace-section" class="workspace-form" style="display: none;">
                <h2 class="workspace-form__title">Create New Workspace</h2>
                <form id="create-workspace-form">
                    <div class="form-group">
                        <label for="workspace-name">Workspace Name *</label>
                        <input type="text" id="workspace-name" name="name" placeholder="Enter workspace name" required>
                    </div>
                    <div class="form-group">
                        <label for="workspace-description">Description (optional)</label>
                        <textarea id="workspace-description" name="description" placeholder="Describe your workspace..." rows="3"></textarea>
                    </div>
                    <div class="workspace-form__actions">
                        <button type="button" class="btn btn-tertiary" id="cancel-create">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Workspace</button>
                    </div>
                </form>
            </div>

            <!-- Workspace Actions -->
            <div id="workspace-actions" class="workspace-actions" style="display: none;">
                <div class="workspace-actions__header">
                    <h2>Your Workspaces</h2>
                    <button class="btn btn-primary" id="show-create-form">
                        <i class="fas fa-plus"></i>
                        Create Workspace
                    </button>
                </div>
            </div>

            <!-- Workspaces List -->
            <div id="workspaces-container" class="workspace-list" style="display: none;">
                <!-- Workspaces will be dynamically loaded here -->
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="workspace-empty-state" style="display: none;">
                <i class="fas fa-briefcase"></i>
                <h3>No workspaces yet</h3>
                <p>Create your first workspace to start organizing your agents and applications.</p>
                <button class="btn btn-primary" id="create-first-workspace">Create Workspace</button>
            </div>

            <!-- Error State -->
            <div id="error-state" class="workspace-empty-state" style="display: none;">
                <i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i>
                <h3>Failed to load workspaces</h3>
                <p id="error-message">Please try again later.</p>
                <button class="btn btn-primary" id="retry-load">Try Again</button>
            </div>
        </main>
    </div>

    <!-- Workspace Detail Modal -->
    <div id="workspace-modal" class="login-modal" style="display: none;">
        <div class="login-modal-content" style="max-width: 800px;">
            <button class="login-modal-close" id="close-workspace-modal">
                <i class="fas fa-times"></i>
            </button>
            <div id="workspace-modal-content">
                <!-- Workspace details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Theme management
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const currentTheme = localStorage.getItem('theme') || 'light';

        if (currentTheme === 'dark') {
            document.body.classList.add('dark-theme');
            themeIcon.className = 'fas fa-sun';
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            themeIcon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Workspace Management
        class WorkspaceManager {
            constructor() {
                this.currentUser = null;
                this.workspaces = [];
                this.init();
            }

            getAuthHeaders() {
                const token = localStorage.getItem('jwtToken');
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                return headers;
            }

            async init() {
                await this.loadCurrentUser();
                if (this.currentUser) {
                    await this.loadWorkspaces();
                    this.bindEvents();
                }
            }

            async loadCurrentUser() {
                try {
                    const response = await fetch('/api/auth/user', {
                        headers: this.getAuthHeaders(),
                        credentials: 'include'
                    });
                    if (response.ok) {
                        this.currentUser = await response.json();
                        const authHeader = response.headers.get('Authorization');
                        if (authHeader && authHeader.startsWith('Bearer ')) {
                            const token = authHeader.substring(7);
                            localStorage.setItem('jwtToken', token);
                        }
                        this.updateUserProfile();
                    } else if (response.status === 401) {
                        window.location.href = '/';
                    } else {
                        console.error('Failed to load user:', response.status);
                        this.showErrorState('Failed to authenticate user.');
                        this.currentUser = null;
                    }
                } catch (error) {
                    console.error('Failed to load user:', error);
                    this.showErrorState('Network error during authentication.');
                    this.currentUser = null;
                }
            }

            updateUserProfile() {
                if (this.currentUser) {
                    const userName = document.getElementById('user-name');
                    const userAvatar = document.querySelector('.user-avatar');
                    userName.textContent = this.currentUser.name || this.currentUser.email;
                    if (this.currentUser.pictureUrl) {
                        userAvatar.innerHTML = `<img src="${this.currentUser.pictureUrl}" alt="${this.currentUser.name}" style="width: 100%; height: 100%; border-radius: 50%;">`;
                    } else {
                        const initials = this.getInitials(this.currentUser.name || this.currentUser.email);
                        userAvatar.setAttribute('data-initials', initials);
                        userAvatar.innerHTML = '';
                    }
                }
            }

            getInitials(name) {
                if (!name) return '';
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            }

            async loadWorkspaces() {
                try {
                    this.showLoadingState();
                    const response = await fetch('/api/workspaces', {
                        headers: this.getAuthHeaders(),
                        credentials: 'include'
                    });
                    if (response.ok) {
                        this.workspaces = await response.json();
                        this.renderWorkspaces();
                    } else {
                        this.showErrorState('Failed to load workspaces');
                    }
                } catch (error) {
                    console.error('Failed to load workspaces:', error);
                    this.showErrorState('Network error occurred');
                }
            }

            renderWorkspaces() {
                const container = document.getElementById('workspaces-container');
                const actions = document.getElementById('workspace-actions');
                const emptyState = document.getElementById('empty-state');
                const loadingState = document.getElementById('loading-state');
                const createWorkspaceSection = document.getElementById('create-workspace-section');

                loadingState.style.display = 'none';
                createWorkspaceSection.style.display = 'none';

                if (this.workspaces.length === 0) {
                    emptyState.style.display = 'block';
                    container.style.display = 'none';
                    actions.style.display = 'none';
                } else {
                    emptyState.style.display = 'none';
                    container.style.display = 'grid';
                    actions.style.display = 'block';

                    container.innerHTML = this.workspaces.map(ws => this.renderWorkspaceCard(ws)).join('');
                    
                    document.querySelectorAll('.workspace-card').forEach(card => {
                        card.addEventListener('click', (e) => {
                            if (e.target.closest('button')) return;
                            const id = card.dataset.workspaceId;
                            this.openWorkspaceModal(id);
                        });
                    });

                    document.querySelectorAll('.share-workspace').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const id = e.currentTarget.dataset.workspaceId;
                            this.openWorkspaceModal(id);
                        });
                    });
                }
            }
            
            renderWorkspaceCard(workspace) {
                const userRole = this.getUserRoleInWorkspace(workspace);
                const roleClass = userRole === 'ADMIN' ? 'workspace-card__role--admin' : 'workspace-card__role--user';
                const roleIcon = userRole === 'ADMIN' ? 'fa-crown' : 'fa-user';
                const isOwner = workspace.ownerId === this.currentUser?.id;

                return `
                    <div class="workspace-card" data-workspace-id="${workspace.id}">
                        <div class="workspace-card__header">
                            <div>
                                <h3 class="workspace-card__title">${workspace.name}</h3>
                                <span class="workspace-card__role ${roleClass}">
                                    <i class="fas ${roleIcon}"></i>
                                    ${isOwner ? 'OWNER' : userRole}
                                </span>
                            </div>
                            <div class="workspace-card__actions">
                                ${isOwner ? `
                                    <button class="btn btn-icon share-workspace" title="Manage users" data-workspace-id="${workspace.id}">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="workspace-card__body">
                            <p>${workspace.description || 'No description'}</p>
                        </div>
                        <div class="workspace-card__footer">
                            <div class="user-avatars">
                                ${workspace.users.slice(0, 5).map(user => `<div class="user-avatar user-avatar--small" data-initials="${this.getInitials(user.email)}"></div>`).join('')}
                                ${workspace.users.length > 5 ? `<div class="user-avatar user-avatar--small" data-initials="+${workspace.users.length - 5}"></div>` : ''}
                            </div>
                        </div>
                    </div>`;
            }

            getUserRoleInWorkspace(workspace) {
                if (workspace.ownerId === this.currentUser?.id) {
                    return 'ADMIN';
                }
                const sharedUser = workspace.users.find(u => u.id === this.currentUser?.id);
                return sharedUser ? sharedUser.role : 'USER';
            }

            bindEvents() {
                document.getElementById('show-create-form').addEventListener('click', () => this.showCreateForm());
                document.getElementById('create-first-workspace').addEventListener('click', () => this.showCreateForm());
                document.getElementById('cancel-create').addEventListener('click', () => this.hideCreateForm());
                document.getElementById('create-workspace-form').addEventListener('submit', (e) => this.handleCreateWorkspace(e));
                document.getElementById('retry-load').addEventListener('click', () => this.loadWorkspaces());

                document.getElementById('close-workspace-modal').addEventListener('click', () => {
                    document.getElementById('workspace-modal').style.display = 'none';
                });
            }

            showLoadingState() {
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('workspaces-container').style.display = 'none';
                document.getElementById('workspace-actions').style.display = 'none';
            }

            showErrorState(message) {
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-message').textContent = message;
            }

            showCreateForm() {
                document.getElementById('create-workspace-section').style.display = 'block';
                document.getElementById('workspace-actions').style.display = 'none';
            }

            hideCreateForm() {
                document.getElementById('create-workspace-section').style.display = 'none';
                document.getElementById('workspace-actions').style.display = 'block';
                document.getElementById('create-workspace-form').reset();
            }

            async handleCreateWorkspace(e) {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = { name: formData.get('name'), description: formData.get('description') };

                try {
                    const response = await fetch('/api/workspaces', {
                        method: 'POST',
                        headers: this.getAuthHeaders(),
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        this.hideCreateForm();
                        await this.loadWorkspaces();
                    } else {
                        const error = await response.json();
                        alert('Failed to create workspace: ' + (error.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Failed to create workspace:', error);
                    alert('Network error occurred');
                }
            }

            async openWorkspaceModal(workspaceId) {
                const modal = document.getElementById('workspace-modal');
                const content = document.getElementById('workspace-modal-content');
                content.innerHTML = '<p>Loading details...</p>';
                modal.style.display = 'flex';

                try {
                    const response = await fetch(`/api/workspaces/${workspaceId}`, { 
                        headers: this.getAuthHeaders(),
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const workspace = await response.json();
                        content.innerHTML = this.renderWorkspaceDetails(workspace);
                        this.bindModalEvents(workspace);
                    } else {
                        content.innerHTML = '<p>Error loading details.</p>';
                    }
                } catch (error) {
                    console.error(`Failed to load workspace ${workspaceId}:`, error);
                    content.innerHTML = '<p>Network error.</p>';
                }
            }

            renderWorkspaceDetails(workspace) {
                const isOwner = workspace.ownerId === this.currentUser?.id;

                return `
                    <div class="workspace-detail">
                        <div class="workspace-detail__header">
                            <h2>${workspace.name}</h2>
                            <p>${workspace.description || 'No description provided.'}</p>
                        </div>
                        <div class="workspace-detail__users">
                            <h3>Users</h3>
                            <div class="user-list">
                                ${workspace.users.map(user => `
                                    <div class="user-list-item">
                                        <span>${user.email} (${user.role})</span>
                                        ${isOwner && user.id !== this.currentUser.id ? `
                                            <button class="btn btn-icon btn-danger remove-user" data-user-id="${user.id}" title="Remove user">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                            ${isOwner ? `
                                <form id="share-workspace-form" class="share-form">
                                    <input type="email" name="email" placeholder="User email to share with" required>
                                    <select name="role">
                                        <option value="USER">User</option>
                                        <option value="ADMIN">Admin</option>
                                    </select>
                                    <button type="submit" class="btn btn-primary">Share</button>
                                </form>
                            ` : ''}
                        </div>
                         ${isOwner ? `
                            <div class="workspace-detail__danger-zone">
                                <h3>Danger Zone</h3>
                                <button class="btn btn-danger" id="delete-workspace-btn">Delete this workspace</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            bindModalEvents(workspace) {
                const isOwner = workspace.ownerId === this.currentUser?.id;

                if (isOwner) {
                    const shareForm = document.getElementById('share-workspace-form');
                    if(shareForm) {
                        shareForm.addEventListener('submit', async (e) => {
                            e.preventDefault();
                            const email = e.target.email.value;
                            const role = e.target.role.value;
                            try {
                                const response = await fetch(`/api/workspaces/${workspace.id}/share`, {
                                    method: 'POST',
                                    headers: this.getAuthHeaders(),
                                    credentials: 'include',
                                    body: JSON.stringify({ email, role })
                                });
                                if (response.ok) {
                                    this.openWorkspaceModal(workspace.id); // Refresh modal
                                } else {
                                    const error = await response.json();
                                    alert(`Error sharing: ${error.error}`);
                                }
                            } catch (error) {
                                console.error('Failed to share workspace:', error);
                            }
                        });
                    }

                    const deleteBtn = document.getElementById('delete-workspace-btn');
                    if(deleteBtn) {
                        deleteBtn.addEventListener('click', async () => {
                            if (confirm('Are you sure you want to delete this workspace? This cannot be undone.')) {
                                try {
                                    const response = await fetch(`/api/workspaces/${workspace.id}`, {
                                        method: 'DELETE',
                                        headers: this.getAuthHeaders()
                                    });
                                    if (response.ok) {
                                        document.getElementById('workspace-modal').style.display = 'none';
                                        this.loadWorkspaces();
                                    } else {
                                        alert('Failed to delete workspace.');
                                    }
                                } catch (error) {
                                    console.error('Failed to delete workspace:', error);
                                }
                            }
                        });
                    }

                    document.querySelectorAll('.remove-user').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            if (confirm('Are you sure you want to remove this user from the workspace?')) {
                                try {
                                    const response = await fetch(`/api/workspaces/${workspace.id}/users/${userId}`, {
                                        method: 'DELETE',
                                        headers: this.getAuthHeaders(),
                                        credentials: 'include' // Include cookies for session-based auth
                                    });
                                    if (response.ok) {
                                        this.openWorkspaceModal(workspace.id); // Refresh modal
                                    } else {
                                        const error = await response.json();
                                        alert(`Failed to remove user: ${error.error}`);
                                    }
                                } catch (error) {
                                    console.error('Failed to remove user:', error);
                                    alert('Network error while removing user.');
                                }
                            }
                        });
                    });
                }
            }

            async shareWorkspace(workspace, email, role) {
                try {
                    const response = await fetch(`/api/workspaces/${workspace.id}/share`, {
                        method: 'POST',
                        headers: this.getAuthHeaders(),
                        credentials: 'include',
                        body: JSON.stringify({ email, role })
                    });
                    
                    if (response.ok) {
                        const updatedWorkspace = await response.json();
                        this.renderWorkspaceDetails(updatedWorkspace);
                        return true;
                    } else {
                        const error = await response.json();
                        alert('Failed to share workspace: ' + (error.error || 'Unknown error'));
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to share workspace:', error);
                    alert('Network error occurred');
                    return false;
                }
            }

            async deleteWorkspace(workspace) {
                if (!confirm(`Are you sure you want to delete the workspace "${workspace.name}"?`)) {
                    return false;
                }

                try {
                    const response = await fetch(`/api/workspaces/${workspace.id}`, {
                        method: 'DELETE',
                        headers: this.getAuthHeaders(),
                        credentials: 'include' // Include cookies for session-based auth
                    });
                    
                    if (response.ok) {
                        this.hideWorkspaceModal();
                        await this.loadWorkspaces();
                        return true;
                    } else {
                        const error = await response.json();
                        alert('Failed to delete workspace: ' + (error.error || 'Unknown error'));
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to delete workspace:', error);
                    alert('Network error occurred');
                    return false;
                }
            }

            async removeUserFromWorkspace(workspace, userId) {
                if (!confirm('Are you sure you want to remove this user from the workspace?')) {
                    return false;
                }

                try {
                    const response = await fetch(`/api/workspaces/${workspace.id}/users/${userId}`, {
                        method: 'DELETE',
                        headers: this.getAuthHeaders(),
                        credentials: 'include' // Include cookies for session-based auth
                    });
                    
                    if (response.ok) {
                        const updatedWorkspace = await response.json();
                        this.renderWorkspaceDetails(updatedWorkspace);
                        return true;
                    } else {
                        const error = await response.json();
                        alert('Failed to remove user: ' + (error.error || 'Unknown error'));
                        return false;
                    }
                } catch (error) {
                    console.error('Failed to remove user:', error);
                    alert('Network error occurred');
                    return false;
                }
            }
        }

        new WorkspaceManager();
    </script>
</body>
</html> 